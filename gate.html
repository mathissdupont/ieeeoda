<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>GeÃ§iÅŸ (QR)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="assets/techops.ico" type="image/x-icon" />
<style>
  :root{--ink:#12223a; --muted:#6d7a90; --edge:#bcd2e8; --bg:#f4f7fb; --pri:#0a7cc1; --ok:#1a7f37; --err:#b00020;}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto; margin:0; background:var(--bg); color:var(--ink)}
  .wrap{max-width:860px; margin:24px auto; padding:16px}
  .card{background:#fff; border-radius:14px; box-shadow:0 8px 22px #002b5c14; padding:18px}
  h1{margin:0 0 8px; font-size:22px}
  #reader{width:100%; min-height:240px; background:#eef4fb; border:1px dashed var(--edge); border-radius:12px; display:grid; place-items:center}
  .status{margin-top:10px; min-height:22px; font-weight:600}
  .ok{color:var(--ok)} .err{color:var(--err)} .muted{color:var(--muted)}
  .pill{display:inline-block; padding:6px 10px; background:#e6f3ff; color:#0a5aa6; border-radius:999px; font-size:12px}
  .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; align-items:center}
  input,button,select{padding:12px; border-radius:10px; border:1px solid #d7dfeb; font-size:14px; background:#fbfdff}
  button{background:var(--pri); color:#fff; border:none; cursor:pointer; font-weight:800}
  button.ghost{background:#eef4fb; color:#0b3a6f}
  .hint{font-size:13px; color:#60738a; margin-top:8px}
  .right{margin-left:auto}
  .hide{display:none}
  .big{font-size:18px; font-weight:800}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>GeÃ§iÅŸ (QR)</h1>
    <span class="pill">KamerayÄ± QRâ€™a tutun veya linkle gelin</span>

    <div class="row">
      <button id="startBtn">ðŸ“· KamerayÄ± BaÅŸlat</button>
      <select id="camSelect" class="hide"></select>
      <button id="restartBtn" class="ghost hide">Yeniden BaÅŸlat</button>
      <button id="torchBtn" class="ghost hide">ðŸ”¦ Fener</button>
      <label class="right"><input type="file" id="fileScan" accept="image/*" class="hide"> Galeriden tara</label>
    </div>

    <div id="reader" style="margin-top:12px"></div>
    <div id="scanStatus" class="status muted">HazÄ±r</div>

    <div id="resultBox" class="hint"></div>

    <div class="row">
      <input id="roomInput" placeholder="Oda Kodu (Ã¶r. LAB-101)" />
      <input id="keyInput"  placeholder="Anahtar (KEY)" />
      <select id="actInput">
        <option value="enter">enter (giriÅŸ)</option>
        <option value="exit">exit (Ã§Ä±kÄ±ÅŸ)</option>
        <option value="break_start">break_start (mola baÅŸlat)</option>
        <option value="break_end">break_end (mola bitir)</option>
      </select>
      <button id="manualBtn" type="button">Onayla</button>
    </div>
    <div class="hint">
      Bu sayfa; <b>room</b>, <b>key</b>, <b>act</b> query parametreleri ile gelindiyse otomatik iÅŸlem yapar.
    </div>
  </div>
</div>

<!-- Scanner -->
<script src="https://unpkg.com/html5-qrcode"></script>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
/* ===== Firebase config ===== */
var firebaseConfig = {
  apiKey: "AIzaSyDJtcrJ6Eh4BfZnn0M-4z9QYi_2AS-ikHw",
  authDomain: "ieee-oda.firebaseapp.com",
  databaseURL: "https://ieee-oda-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "ieee-oda",
  storageBucket: "ieee-oda.firebasestorage.app",
  messagingSenderId: "788998880363",
  appId: "1:788998880363:web:5eacc71c326cffe7b3452e"
};
firebase.initializeApp(firebaseConfig);
var auth = firebase.auth(), db = firebase.database();

/* ===== small utils ===== */
function $(id){ return document.getElementById(id); }
var scanStatus = $('scanStatus');
function show(cls, txt){ scanStatus.className='status '+cls; scanStatus.textContent=txt; }
function urlParam(n){ try{ return new URL(location.href).searchParams.get(n); }catch(_){ return null; } }
function encodeParams(p){ return Object.keys(p).map(function(k){return k+'='+encodeURIComponent(p[k]||'');}).join('&'); }
function resultInfo(html){ $('resultBox').innerHTML = html; }

/* ===== key generation: SAME RULES as kiosk (UTC hour) ===== */
function hourTokenUTC(d){
  d = d || new Date();
  var y = d.getUTCFullYear();
  var m = ('0'+(d.getUTCMonth()+1)).slice(-2);
  var day = ('0'+d.getUTCDate()).slice(-2);
  var h = ('0'+d.getUTCHours()).slice(-2);
  return ''+y+m+day+h; // YYYYMMDDHH
}
function sha256Hex(s){
  var enc = new TextEncoder().encode(s);
  return crypto.subtle.digest('SHA-256', enc).then(function(buf){
    var arr = Array.from(new Uint8Array(buf));
    return arr.map(function(b){ return b.toString(16).padStart(2,'0'); }).join('');
  });
}
function takeKey6FromHex(hex){
  var map='0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  var out=''; 
  for(var i=0;i<hex.length && out.length<6;i++){
    var v=parseInt(hex[i],16);
    out+=map[v % map.length];
  }
  return out.toUpperCase();
}
function computeHourlyKey(seed,date){
  return sha256Hex(seed + hourTokenUTC(date||new Date())).then(takeKey6FromHex);
}

/* ===== seed fetch (two spellings) ===== */
function fetchSeed(room){
  return db.ref('roomKeySeed/'+room).get().then(function(s){
    if (s.exists()) return String(s.val());
    return db.ref('roomkeySeed/'+room).get().then(function(s2){
      if (s2.exists()) return String(s2.val());
      throw new Error('Oda iÃ§in seed yok.');
    });
  });
}

/* ===== verify room+key (accept current or prev UTC hour) ===== */
function verifyRoomKey(room, key){
  if (!room || !key) return Promise.reject(new Error('Oda veya key eksik.'));
  return fetchSeed(room).then(function(seed){
    var now = new Date();
    var prev = new Date(now.getTime() - 3600*1000);
    return Promise.all([computeHourlyKey(seed, now), computeHourlyKey(seed, prev)]).then(function(ks){
      var kNow = ks[0].toUpperCase(), kPrev = ks[1].toUpperCase();
      var kk = String(key).toUpperCase();
      if (kk!==kNow && kk!==kPrev) throw new Error('Anahtar hatalÄ± veya sÃ¼resi dolmuÅŸ.');
      return true;
    });
  });
}

/* ===== write attendance (both room & user trees) =====
   Security rules (senin kurallarÄ±n):
   attendanceByRoom/$roomId/$pushid: write if auth!=null && newData.userId===auth.uid
   attendanceByUser/$uid/$pushid   : write if auth.uid===$uid
   Payload must include: userId, roomId, action, createdAt
*/
var ALLOWED_ACTS = { enter:1, exit:1, break_start:1, break_end:1 };

function writeAttendance(uid, room, act){
  if (!ALLOWED_ACTS[act]) return Promise.reject(new Error('GeÃ§ersiz iÅŸlem (act).'));
  var now = Date.now();
  var payload = { userId: uid, roomId: room, action: act, createdAt: now };

  var p1 = db.ref('attendanceByRoom/'+room).push(payload);
  var p2 = db.ref('attendanceByUser/'+uid).push(payload);
  return Promise.all([p1,p2]);
}

/* ===== main flow (with deep-link support) ===== */
function requireAuthThen(fn){
  return new Promise(function(resolve,reject){
    var unsub = auth.onAuthStateChanged(function(u){
      unsub();
      if (!u){
        // redirect to login and come back to this URL
        var nextUrl = location.pathname + location.search;
        location.replace('login.html?next='+encodeURIComponent(nextUrl));
        // not resolving/rejecting; navigation will occur.
      }else{
        resolve(u);
      }
    });
  }).then(fn);
}

function handleLinkFlow(room, key, act){
  show('muted', 'DoÄŸrulanÄ±yorâ€¦');
  if (!ALLOWED_ACTS[act]){ show('err','GeÃ§ersiz act parametresi.'); return; }

  // 1) verify key
  verifyRoomKey(room, key).then(function(){
    // 2) ensure auth & write
    return requireAuthThen(function(u){
      return writeAttendance(u.uid, room, act).then(function(){
        show('ok', 'Ä°ÅŸlem tamam âœ…');
        var textAct = (act==='enter'?'GiriÅŸ':
                      act==='exit'?'Ã‡Ä±kÄ±ÅŸ':
                      act==='break_start'?'Mola baÅŸlangÄ±cÄ±':'Mola bitiÅŸi');
        resultInfo(
          '<div class="big">'+ textAct +' kaydedildi.</div>' +
          '<div class="hint">KullanÄ±cÄ±: '+(u.displayName||u.email||u.uid)+'<br>Oda: '+room+'</div>'
        );
      });
    });
  }).catch(function(e){
    show('err', e && e.message ? e.message : String(e));
  });
}

/* ===== QR SCANNER ===== */
var qr = null, currentCamId = null, torchOn = false;
var readerEl = $('reader');

function calcQrBox(){
  var w = Math.max(180, Math.min(360, Math.floor(readerEl.getBoundingClientRect().width*0.8)));
  return { width:w, height:w };
}
function listCameras(){
  return Html5Qrcode.getCameras().then(function(cams){
    var sel=$('camSelect'); sel.innerHTML='';
    cams.forEach(function(c){
      var o=document.createElement('option');
      o.value=c.id; o.textContent=c.label || (c.id && c.id.indexOf('back')>=0 ? 'Arka Kamera' : 'Kamera');
      sel.appendChild(o);
    });
    if(cams[0]) sel.value=cams[0].id;
    sel.classList.remove('hide');
    $('restartBtn').classList.remove('hide');
    $('fileScan').classList.remove('hide');
    return cams;
  });
}
function startCamera(camId){
  if(!qr) qr = new Html5Qrcode('reader', { verbose:false });
  if(qr.isScanning){ return qr.stop().then(function(){ return startCamera(camId); }); }
  var config={ fps:10, qrbox: calcQrBox() };
  var constraints = camId ? { deviceId:{exact:camId} } : { facingMode:'environment' };
  return qr.start(constraints, config, onScanSuccess, onScanFail).then(function(){
    currentCamId = camId || null;
    $('torchBtn').classList.remove('hide');
  });
}
function onScanSuccess(decodedText){
  // BeklediÄŸimiz format: gate.html?room=...&key=...&act=...
  try{
    var u = new URL(decodedText);
    var r = u.searchParams.get('room');
    var k = u.searchParams.get('key');
    var a = u.searchParams.get('act');
    if (r && k && a){
      // aynÄ± sayfaya yÃ¶nlendir, link flow tetiklensin
      location.href = location.pathname + '?'+encodeParams({room:r, key:k, act:a});
      return;
    }
  }catch(_){}
  show('err', 'GeÃ§ersiz QR.');
}
function onScanFail(){}

/* ===== UI bindings ===== */
$('startBtn').onclick = function(){
  show('muted','Kamera izinleri isteniyorâ€¦');
  listCameras().then(function(){ return startCamera($('camSelect').value); })
               .then(function(){ show('muted','Kamera aktif. QRâ€™Ä± okutun.'); })
               .catch(function(e){ show('err','Kamera aÃ§Ä±lamadÄ±: '+(e && e.message ? e.message : e)); });
};
$('camSelect').onchange = function(){ startCamera($('camSelect').value).catch(function(e){ show('err','BaÅŸlatÄ±lamadÄ±: '+e); }); };
$('restartBtn').onclick = function(){ startCamera($('camSelect').value).catch(function(e){ show('err','BaÅŸlatÄ±lamadÄ±: '+e); }); };

// Torch (desteklemeyebilir)
$('torchBtn').onclick = function(){
  if(!qr || !qr.getState) return;
  try{
    qr.applyVideoConstraints({ advanced:[{ torch: !torchOn }] }).then(function(){
      torchOn = !torchOn;
      $('torchBtn').textContent = torchOn ? 'ðŸ”¦ Fener (AÃ§Ä±k)' : 'ðŸ”¦ Fener';
    }).catch(function(){ $('torchBtn').classList.add('hide'); });
  }catch(_){ $('torchBtn').classList.add('hide'); }
};

// Dosyadan okuma
$('fileScan').onchange = function(ev){
  var f = ev.target.files && ev.target.files[0];
  if(!f) return;
  if(!qr) qr = new Html5Qrcode('reader');
  qr.scanFile(f, true).then(onScanSuccess).catch(function(e){
    show('err','Resimden okuma baÅŸarÄ±sÄ±z: '+(e && e.message ? e.message : e));
  });
};

// Manuel
$('manualBtn').onclick = function(){
  var room = $('roomInput').value.trim();
  var key  = $('keyInput').value.trim();
  var act  = $('actInput').value;
  if (!ALLOWED_ACTS[act]){ show('err','GeÃ§ersiz iÅŸlem.'); return; }
  // parametrelerle kendi kendine yÃ¶nlendir (tek akÄ±ÅŸ)
  location.href = location.pathname + '?'+encodeParams({room:room, key:key, act:act});
};

/* ===== Deep link (auto) ===== */
(function init(){
  var room = urlParam('room');
  var key  = urlParam('key');
  var act  = urlParam('act');
  if (room && key && act){
    handleLinkFlow(room, key, act);
  }else{
    show('muted','HazÄ±r. KamerayÄ± baÅŸlatÄ±n veya manuel girin.');
  }

  // responsive yeniden baÅŸlat
  var resizeTimer=null;
  window.addEventListener('resize', function(){
    clearTimeout(resizeTimer);
    resizeTimer=setTimeout(function(){
      if(qr && qr.isScanning){ qr.stop().then(function(){ startCamera(currentCamId||$('camSelect').value); }).catch(function(){}); }
    }, 200);
  });
})();
</script>
</body>
</html>
