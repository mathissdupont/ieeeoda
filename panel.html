<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<link rel="icon" href="assets/techops.ico" type="image/x-icon" />
<title>Oda Paneli</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#f6f9ff; --ink:#10243b; --muted:#6d7a90; --edge:#e9eff8; --card:#fff;
    --pri:#0a7cc1; --pri-2:#095f97; --ok:#1a7f37; --warn:#b06b00; --err:#c62828;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#0f141b; --ink:#e9eef5; --muted:#9fb0c8; --edge:#223244; --card:#0f1a27;
      --pri:#2aa3ff; --pri-2:#63b7ff; --ok:#2ecc71; --warn:#ffd27a; --err:#ff6b6b;
    }
  }

  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; background:var(--bg); color:var(--ink); margin:0}
  .wrap{max-width:1100px; margin:20px auto; padding:16px}

  /* header */
  .top{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
  .title{display:flex; align-items:center; gap:10px}
  h2{margin:0; font-size:20px}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:#e6f3ff; color:#0a5aa6; border-radius:999px; font-size:12px; border:1px solid var(--edge)}
  .presence{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid var(--edge)}
  .presence.in{background:#e8f6ee; color:#126b3a}
  .presence.out{background:#fff2e0; color:#9a5a00}
  .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--err)} .warn{color:var(--warn)}
  .right{margin-left:auto}
  .statusline{min-height:22px; font-weight:700; margin-top:6px}

  /* tiles */
  .tiles{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:12px; margin-top:14px}
  @media (max-width:900px){ .tiles{grid-template-columns:repeat(2,minmax(0,1fr));} }
  @media (max-width:520px){ .tiles{grid-template-columns:1fr;} }
  .tile{background:var(--card); border:1px solid var(--edge); border-radius:14px; padding:14px; display:flex; flex-direction:column; gap:8px; box-shadow:0 10px 24px #001a3b16}
  .tile h3{margin:0; font-size:16px}
  .tile p{margin:0; font-size:12px; color:var(--muted)}
  .btn{padding:12px 12px; border-radius:12px; border:none; font-weight:800; cursor:pointer; background:var(--pri); color:#fff; display:inline-flex; align-items:center; justify-content:center; gap:8px}
  .btn.light{background:#eaf2fd; color:#0b3a6f}
  .btn.secondary{background:#6b7a90}
  .btn:disabled{opacity:.55; cursor:not-allowed}

  /* cards/dialog */
  .card{background:var(--card); border-radius:16px; box-shadow:0 10px 24px #001a3b16; padding:16px; border:1px solid var(--edge)}
  dialog{border:none; border-radius:16px; padding:0; width:min(720px,calc(100% - 24px)); background:var(--card); border:1px solid var(--edge)}
  .dlg-head{padding:14px 16px; border-bottom:1px solid var(--edge); font-weight:800}
  .dlg-body{padding:16px}
  .dlg-foot{padding:14px 16px; border-top:1px solid var(--edge); display:flex; gap:8px; justify-content:flex-end}
  input,select,textarea{width:100%; padding:12px; border:1px solid var(--edge); border-radius:12px; background:#fbfdff}
  textarea{resize:vertical}
  table{width:100%; border-collapse:collapse}
  th,td{padding:10px 12px; border-bottom:1px solid var(--edge); font-size:14px; text-align:left; vertical-align:top}
  th{background:#f2f6fc}
  @media (prefers-color-scheme: dark){
    .card{ background:var(--card); border:1px solid var(--edge); box-shadow:0 8px 22px rgba(0,0,0,.35); }
    th{ background:#18283b; color:var(--ink); }
    td, th{ border-bottom-color:#27384f; }
    input, select, textarea{ background:#0e1622; color:var(--ink); border:1px solid #2d3e55; }
    input:focus, select:focus, textarea:focus{ border-color:#4aa3ff; box-shadow:0 0 0 3px rgba(74,163,255,.18); outline:none; }
    .btn{ background:linear-gradient(90deg, var(--pri) 0%, var(--pri-2) 100%); color:#031424; }
    .btn.light{ background:#132235; color:#d7e7ff; border:1px solid #2d3e55; }
    .btn.secondary{ background:#394b63; color:#e8eef6; }
    .pill{ background:#132235; color:#9bd0ff; border:1px solid #2d3e55; }
    .presence{ border-color:#2d3e55; }
    .presence.in{ background:#103022; color:#9ff0c0; }
    .presence.out{ background:#2e200f; color:#ffca85; }
  }

  /* toast & spinner */
  .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 24px #0006;font-weight:700;opacity:0;pointer-events:none;transition:.25s}
  .toast.show{opacity:1;pointer-events:auto}
  .spinner{width:16px;height:16px;border:2px solid #fff;border-right-color:transparent;border-radius:50%;display:inline-block;vertical-align:middle;animation:spin .7s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* rating + chips */
  .seg{display:flex; gap:8px; flex-wrap:wrap}
  .seg .chip{padding:8px 12px; border:1px solid var(--edge); border-radius:999px; cursor:pointer; background:#f7fbff}
  .seg .chip.active{background:var(--pri); color:#fff; border-color:var(--pri)}
  .stars{display:flex; gap:6px; font-size:20px; cursor:pointer; user-select:none}
  .stars span{filter:grayscale(1); opacity:.5}
  .stars span.on{filter:none; opacity:1}
  .chips{display:flex; flex-wrap:wrap; gap:8px; align-items:center; border:1px solid var(--edge); border-radius:12px; padding:8px; background:#fbfdff}
  .chips .chip{background:#eef6ff; border:1px solid var(--edge); border-radius:999px; padding:6px 10px; cursor:pointer}
  .chips input{border:none; outline:none; min-width:160px; flex:1; background:transparent; padding:6px 4px}
  @media (prefers-color-scheme: dark){
    .chips{background:#0e1622; border-color:#2b3b50}
    .chips .chip{background:#132235; border-color:#2b3b50; color:#d7e7ff}
  }

  /* Takvim Tablosu */
  .schedule-head{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  #schedDate{padding:10px;border:1px solid var(--edge);border-radius:10px;background:#fbfdff;min-width:200px}
  .table-note{font-size:12px;color:var(--muted)}
  .table-slim{width:100%;border-collapse:collapse}
  .table-slim th,.table-slim td{padding:8px 10px;border-bottom:1px solid var(--edge);font-size:14px;text-align:left}
  .slot-free{background:#f2fbf6;color:#166b3a;border:1px solid #cfeedd;border-radius:8px;padding:2px 8px;display:inline-block}
  .slot-pending{background:#fff7e8;color:#8a5a00;border:1px solid #ffe2b8;border-radius:8px;padding:2px 8px;display:inline-block}
  .slot-approved{background:#e9f8ee;color:#126b3a;border:1px solid #ccecd8;border-radius:8px;padding:2px 8px;display:inline-block}
  .slot-declined{background:#ffe9e9;color:#9a1b1b;border:1px solid #ffd0d0;border-radius:8px;padding:2px 8px;display:inline-block}
  .slot-cell{white-space:nowrap}
  .slot-click{cursor:pointer;text-decoration:underline}
  /* === Oda Takvimi — Dark mode kontrast fix === */
@media (prefers-color-scheme: dark){
  /* Modal genel metin */
  #schedDlg .dlg-body { color: var(--ink); }

  /* Tarih inputu: arka plan, yazı, border ve ikon görünürlüğü */
  #schedDate{
    background:#0e1622 !important;
    color:var(--ink) !important;
    border:1px solid #2d3e55 !important;
  }
  /* Chrome/Safari tarih seçici ikonu */
  #schedDate::-webkit-calendar-picker-indicator{
    filter: invert(1) contrast(1.2);
    opacity: 0.9;
  }

  /* Tablo başlık ve hücre renkleri */
  .table-slim th{
    background:#1a2a3f !important;   /* daha açık başlık */
    color:var(--ink) !important;
    border-bottom:1px solid #27384f !important;
  }
  .table-slim td{
    color:var(--ink) !important;
    border-bottom:1px solid #27384f !important;
  }

  /* "Bu slota rezervasyon iste" linki görünürlüğü */
  .slot-click{
    color:#9bd0ff !important;
    text-decoration: underline;
  }

  /* Slot rozetleri: koyu mod paleti */
  .slot-free{
    background:#103022 !important;
    color:#9ff0c0 !important;
    border:1px solid #1e3a2f !important;
  }
  .slot-pending{
    background:#2e240f !important;
    color:#ffd27a !important;
    border:1px solid #5a471e !important;
  }
  .slot-approved{
    background:#103022 !important;
    color:#9ff0c0 !important;
    border:1px solid #1e3a2f !important;
  }
  .slot-declined{
    background:#3a1414 !important;
    color:#ff9b9b !important;
    border:1px solid #5a2020 !important;
  }

  /* Küçük not yazısı */
  .table-note{ color:#a9b7c8 !important; }
}

/* === Responsive iyileştirme katmanı (ekle: en alta) === */

/* 1) Daha akıcı ızgara: kartlar 220px altına düşmeden otomatik sarmalansın */
.tiles{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: clamp(10px, 2vw, 14px);
}

/* 2) Üst bar: öğeler dar ekranda taşmadan hizalansın */
.top{
  align-items: stretch;
  gap: clamp(8px, 1.5vw, 12px);
}
.title{
  flex: 1 1 auto;
  min-width: 260px;            /* pill'ler kırpılmasın */
}
.right{
  flex: 0 0 auto;
  display:flex;
  align-items:center;
  gap: 10px;
}

/* 3) Kart içi butonlar dar ekranda kolay tıklansın */
@media (max-width: 560px){
  .tile .btn{ width:100%; }
}

/* 4) Dialoglar ve formlar: küçük ekranda kenarlara yapışmasın */
dialog{
  width: min(740px, calc(100% - 20px)); /* biraz daha esnek */
}
.dlg-body, .dlg-foot{
  padding: clamp(12px, 2.6vw, 16px);
}

/* 5) Tablo taşması: küçük ekranda yatay kaydırma ver, içerik kırılmasın */
.card table, dialog table, .table-slim{
  display:block;
  width:100%;
  overflow-x:auto;
  white-space: nowrap;
  -webkit-overflow-scrolling: touch;
  border-collapse: separate;   /* iOS kaydırma bug fix */
}

/* 6) Tipografi ve boşluklar: ekran genişliğine göre akışkan */
h2{
  font-size: clamp(16px, 1.3vw + 12px, 20px);
}
.wrap{
  padding: clamp(12px, 2.4vw, 16px);
}

/* 7) Pill & presence: dar ekranda taşmayı engelle */
.pill, .presence{
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* 8) Tarih girdi ve küçük inputlar dar ekranda kırılmadan sığsın */
#schedDate,
input[type="datetime-local"],
input[type="date"],
input[type="number"]{
  min-width: 0;                /* flex konteyner içinde taşmayı engeller */
}

/* 9) Erişilebilirlik: hareket azaltma tercihinde animasyonları kıs */
@media (prefers-reduced-motion: reduce){
  .spinner{ animation: none; }
  *{ scroll-behavior: auto; }
}

/* 10) Koyu modda tablo başlık/ayrım kontrastını biraz daha arttır */
@media (prefers-color-scheme: dark){
  .table-slim th{ background:#17263a; }
  td, th{ border-bottom-color:#2a3a51; }
}

/* === Üst şerit düzen/overflow fix === */
.top{
  display: grid;                       /* flex yerine grid */
  grid-template-columns: 1fr auto;     /* sol info + sağ buton */
  align-items: center;
  gap: 8px 12px;
}

.title{
  display: flex;
  flex-wrap: wrap;                     /* pill'leri sar */
  align-items: center;
  gap: 8px;
  min-width: 0;                        /* overflow fix */
}

.title h2{ flex: 0 0 auto; margin-right: 4px; }

.pill, .presence{
  max-width: 100%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Sağ blok: inline style varsa ezmek için !important kullanıyoruz */
.right{
  justify-self: end;
  display:flex !important;
  align-items:center !important;
  gap:10px !important;
}

/* Küçük ekran optimizasyonu */
@media (max-width: 720px){
  .top{ grid-template-columns: 1fr; }   /* buton alt satıra insin */
  .right{ justify-self: end; }
  .pill, .presence{ padding: 4px 8px; font-size: 11px; }
  .btn.secondary{ padding: 8px 10px; }  /* çıkış butonu daha kompakt */
  #hello{ display:none; }               /* selam metni mobilde gizle */
}

/* Müsaitlik pill renkleri */
.pill.avail-free  { background:#e9f8ee; color:#126b3a; border:1px solid #ccecd8; }
.pill.avail-busy  { background:#ffe9e9; color:#9a1b1b; border:1px solid #ffd0d0; }
.pill.avail-warn  { background:#fff7e8; color:#8a5a00; border:1px solid #ffe2b8; }

@media (prefers-color-scheme: dark){
  .pill.avail-free { background:#103022; color:#9ff0c0; border-color:#1e3a2f; }
  .pill.avail-busy { background:#3a1414; color:#ff9b9b; border-color:#5a2020; }
  .pill.avail-warn { background:#2e240f; color:#ffd27a; border-color:#5a471e; }
}

/* Zorunlu alan hatası vurgusu */
.invalid{ border-color:#c62828 !important; box-shadow:0 0 0 3px rgba(198,40,40,.15) !important; }
@media (prefers-color-scheme: dark){
  .invalid{ border-color:#ff6b6b !important; box-shadow:0 0 0 3px rgba(255,107,107,.16) !important; }
}



</style>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <div class="top">
    <div class="title">
      <h2>Oda Paneli</h2>
      <span id="roomPill" class="pill"></span>
      <span id="occPill" class="pill" title="Şu an içeride">👥 0</span>
      <span id="presence" class="presence" aria-live="polite">Durum yükleniyor…</span>
      <span id="availPill" class="pill" title="Anlık müsaitlik">Durum yükleniyor…</span>
      <span class="pill" title="Bugün toplam"><strong id="sumToday">00:00:00</strong></span>
      <span class="pill" title="Son hareket" id="lastAction">—</span>
    </div>
    <div class="right" style="display:flex;align-items:center;gap:10px">
      <div class="muted" id="hello"></div>
      <button id="logout" class="btn secondary">Çıkış</button>
    </div>
  </div>
  <div id="opStatus" class="statusline muted"></div>

  <div id="dash" class="card" style="margin-top:12px">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div>
        <div style="font-weight:800;margin-bottom:8px">Yaklaşan Rezervasyonlar</div>
        <ul id="dashUpcoming" style="margin:0;padding-left:18px">
          <li class="muted">Yükleniyor…</li>
        </ul>
      </div>
  </div>


  <!-- Tiles -->
  <div class="tiles">
    <div class="tile">
      <h3>Oda Takvimi</h3>
      <p>30 dk slot — dolu/boş & kullanıcı</p>
      <button id="openSched" class="btn light">📅 Aç</button>
    </div>
    <div class="tile">
      <h3>Rezervasyon</h3>
      <p>Talep oluştur, yaklaşanları gör</p>
      <button id="openRes" class="btn light">📝 Aç</button>
    </div>
    <div class="tile">
      <h3>Eksik/Ekipman</h3>
      <p>Marker, kablo, donanım vs. talep et</p>
      <button id="openInv" class="btn light">📦 Aç</button>
    </div>
    <div class="tile">
      <h3>Kayıtlarım</h3>
      <p>Son giriş/çıkış/mola kayıtları</p>
      <button id="openLogs" class="btn light">📜 Aç</button>
    </div>
    <div class="tile">
      <h3>Faturalarım</h3>
      <p>Aidat onaylıysa PDF kes</p>
      <button id="openInvcs" class="btn light">🧾 Aç</button>
    </div>
    <div class="tile">
      <h3>Aidat Bildir</h3>
      <p>Dönem ve tutar gir, gönder</p>
      <button id="openDues" class="btn light">💳 Aç</button>
    </div>
    <div class="tile">
      <h3>Günlük Çizelge</h3>
      <p>Bugün giriş-çıkış blokları</p>
      <button id="openTime" class="btn light">📈 Aç</button>
    </div>
  </div>
</div>

<!-- ====== MODALLAR ====== -->

<!-- Aksiyonlar 
<dialog id="actDlg">
  <div class="dlg-head">Oda Aksiyonları</div>
  <div class="dlg-body" style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px">
    <button id="enterBtn"      class="btn" disabled>⤴️ Giriş</button>
    <button id="exitBtn"       class="btn light" disabled>⤵️ Çıkış (+Yorum)</button>
    <button id="breakStartBtn" class="btn" disabled>☕ Mola</button>
    <button id="breakEndBtn"   class="btn light" disabled>🔙 Mola Bitir</button>
  </div>
  <div class="dlg-foot"><button id="actClose" class="btn light" type="button">Kapat</button></div>
</dialog>
-->
<!-- Çıkış Yorumu (+kamera) -->
<dialog id="exitDlg">
  <div class="dlg-head">Oda Çıkış — Son Durum</div>
  <div class="dlg-body">
    <label>Durum</label>
    <div class="seg" id="statusSeg">
      <div class="chip" data-val="clean">🧽 Temiz / Düzenli</div>
      <div class="chip" data-val="messy">🧹 Dağınık / Toplanmalı</div>
      <div class="chip" data-val="issue">⚠️ Sorun / Arıza</div>
    </div>
    <label style="margin-top:12px">Genel Memnuniyet</label>
    <div class="stars" id="stars" aria-label="Puan"><span>⭐</span><span>⭐</span><span>⭐</span><span>⭐</span><span>⭐</span></div>
    <label style="margin-top:12px">Kısa Yorum</label>
    <textarea id="fbComment" rows="3" placeholder="Örn. projeksiyon bulanık, çöpler dolu, klima gürültülü..."></textarea>

    <label style="margin-top:12px">Oda fotoğrafı</label>
    <div class="seg" style="align-items:flex-start">
      <button id="openCam" class="btn light" type="button">📷 Kameradan Çek</button>
      <img id="exitPreview" alt="Önizleme" style="display:none;max-height:120px;border:1px solid var(--edge);border-radius:8px">
      <div id="photoStatus" class="statusline muted" style="margin:0"></div>
    </div>

    <label style="margin-top:12px">Kimlerle beraberdin? (Enter)</label>
    <div class="chips" id="withBox"><input id="withInput" placeholder="Örn. Ali Y., Ayşe K." /></div>
    <div class="seg" style="margin-top:10px">
      <div class="chip tag" data-tag="temizlik">🧼 Temizlik</div>
      <div class="chip tag" data-tag="donanım">🖥️ Donanım</div>
      <div class="chip tag" data-tag="elektrik">🔌 Elektrik</div>
      <div class="chip tag" data-tag="düzen">🗂️ Düzen</div>
    </div>
  </div>
  <div class="dlg-foot">
    <button class="btn light" id="fbCancel" type="button">Vazgeç</button>
    <button id="fbSend" class="btn" type="button">Gönder & Çıkış Kaydet</button>
  </div>
</dialog>

<!-- Kamera -->
<dialog id="camDlg" style="border:none;border-radius:16px;padding:0;width:min(520px,calc(100% - 24px));background:var(--card);border:1px solid var(--edge)">
  <div class="dlg-head">Kameradan Fotoğraf</div>
  <div class="dlg-body" style="display:flex;flex-direction:column;gap:8px">
    <video id="camVideo" playsinline autoplay style="width:100%;max-height:320px;background:#000;border-radius:12px"></video>
    <canvas id="camCanvas" style="display:none"></canvas>
    <div class="muted" style="font-size:12px">İpucu: Arka kamera için “environment” iyidir.</div>
  </div>
  <div class="dlg-foot">
    <button id="camCancel" class="btn light" type="button">Vazgeç</button>
    <button id="camShoot" class="btn" type="button">📸 Çek</button>
  </div>
</dialog>

<!-- Rezervasyon -->
<dialog id="resDlg">
  <div class="dlg-head">Oda Rezervasyonu</div>
  <div class="dlg-body">
    <div class="seg" style="gap:10px;flex-wrap:wrap">
      <input id="resTitle" placeholder="Başlık (örn. Proje toplantısı)" />
      <input id="resStart" type="datetime-local" />
      <input id="resEnd" type="datetime-local" />
    </div>
    <textarea id="resNote" rows="2" placeholder="Not (ihtiyaçlar, katılımcılar, vb.)" style="margin-top:8px"></textarea>
    <div class="seg" style="margin-top:8px;justify-content:space-between">
      <button id="resSend" class="btn" disabled>📅 Rezervasyon Talep Et</button>
      <div id="resStatus" class="statusline muted" style="margin:0"></div>
    </div>
    <div style="margin-top:10px">
      <div class="muted" style="margin:6px 0 4px">Yaklaşan rezervasyonlar</div>
      <table>
        <thead><tr><th>Zaman</th><th>Başlık</th><th>Durum</th></tr></thead>
        <tbody id="resRows"></tbody>
      </table>
    </div>
  </div>
  <div class="dlg-foot"><button class="btn light" data-close="resDlg">Kapat</button></div>
</dialog>

<!-- Takvim (30 dk slot) -->
<dialog id="schedDlg">
  <div class="dlg-head">Oda Takvimi</div>
  <div class="dlg-body">
    <div class="schedule-head">
      <input id="schedDate" type="date">
      <div class="table-note">30 dk slot; dolu/boş + kullanıcı gösterimi</div>
    </div>
    <table class="table-slim">
      <thead><tr><th>Saat</th><th>Durum</th><th>Başlık / Kullanıcı</th></tr></thead>
      <tbody id="schedRows"><tr><td colspan="3" class="muted">Yükleniyor…</td></tr></tbody>
    </table>
  </div>
  <div class="dlg-foot"><button class="btn light" data-close="schedDlg">Kapat</button></div>
</dialog>

<!-- Envanter -->
<dialog id="invDlg">
  <div class="dlg-head">Eksik / Ekipman Talebi</div>
  <div class="dlg-body">
    <div class="seg">
      <select id="invCat" style="max-width:200px">
        <option value="genel">Kategori</option>
        <option>Temizlik</option>
        <option>Elektrik</option>
        <option>Donanım</option>
        <option>Kırtasiye</option>
        <option>Diğer</option>
      </select>
      <input id="invName" placeholder="Ürün / Ekipman adı (örn. Marker kalem)" />
      <input id="invQty" type="number" min="1" value="1" style="max-width:140px" placeholder="Adet" />
    </div>
    <textarea id="invNote" rows="3" placeholder="Detay/Not (marka, renk, ölçü, vs.)" style="margin-top:8px"></textarea>
    <div class="seg" style="margin-top:8px;justify-content:space-between">
      <button id="invSend" class="btn" disabled>🚀 Talep Gönder</button>
      <div id="invStatus" class="statusline muted" style="margin:0"></div>
    </div>
  </div>
  <div class="dlg-foot"><button class="btn light" data-close="invDlg">Kapat</button></div>
</dialog>

<!-- Kayıtlarım -->
<dialog id="logsDlg">
  <div class="dlg-head">Son Kayıtlarım</div>
  <div class="dlg-body">
    <table>
      <thead><tr><th>Zaman</th><th>Aksiyon</th><th>Oda</th><th>Kaynak</th></tr></thead>
      <tbody id="myRows"></tbody>
    </table>
  </div>
  <div class="dlg-foot"><button class="btn light" data-close="logsDlg">Kapat</button></div>
</dialog>

<!-- Faturalarım -->
<dialog id="invcsDlg">
  <div class="dlg-head">Faturalarım</div>
  <div class="dlg-body">
    <table>
      <thead><tr><th>Zaman</th><th>Başlık</th><th>Tutar</th><th>Durum</th><th></th></tr></thead>
      <tbody id="myInvRows"><tr><td colspan="5" class="muted">Yükleniyor…</td></tr></tbody>
    </table>
  </div>
  <div class="dlg-foot"><button class="btn light" data-close="invcsDlg">Kapat</button></div>
</dialog>

<!-- Aidat -->
<dialog id="duesDlg">
  <div class="dlg-head">Aidat Bildir</div>
  <div class="dlg-body">
    <div class="seg" style="align-items:flex-end; gap:8px">
      <input id="duesMonth" placeholder="YYYY-MM (örn. 2025-10)" style="max-width:180px">
      <input id="duesAmount" type="number" min="0" step="0.01" placeholder="Tutar (₺)" style="max-width:160px">
      <button id="duesSend" class="btn" disabled>🧾 Aidat Bildir</button>
    </div>
    <div id="duesStatus" class="statusline muted" style="margin-top:6px"></div>
  </div>
  <div class="dlg-foot"><button class="btn light" data-close="duesDlg">Kapat</button></div>
</dialog>

<!-- Günlük Çizelge -->
<dialog id="timeDlg">
  <div class="dlg-head">Bugün Zaman Çizelgesi</div>
  <div class="dlg-body">
    <div id="timeline" style="height:18px;background:#e6eefb;border-radius:999px;position:relative"></div>
    <div id="timelineLegend" class="muted" style="margin-top:6px;font-size:12px"></div>
  </div>
  <div class="dlg-foot"><button class="btn light" data-close="timeDlg">Kapat</button></div>
</dialog>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
/* ===== SAFE BOOT ===== */
function safeBoot(fn){
  if (document.readyState === 'complete' || document.readyState === 'interactive') fn();
  else window.addEventListener('DOMContentLoaded', fn);
}
safeBoot(function(){
  if (!window.firebase || !firebase.app || !firebase.auth) {
    const el = document.getElementById('opStatus');
    if (el){ el.className='statusline err'; el.textContent='Bağlantı kütüphanesi yüklenemedi. Ağ/AdBlock/CSP kontrol edin.'; }
    console.error('Firebase scriptleri yüklenmedi (gstatic bloklanmış olabilir).');
    return;
  }

/* ============================== INIT ============================== */
const firebaseConfig = {
  apiKey: "AIzaSyDJtcrJ6Eh4BfZnn0M-4z9QYi_2AS-ikHw",
  authDomain: "ieee-oda.firebaseapp.com",
  databaseURL: "https://ieee-oda-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "ieee-oda",
  storageBucket: "ieee-oda.firebasestorage.app",
  messagingSenderId: "788998880363",
  appId: "1:788998880363:web:5eacc71c326cffe7b3452e"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.database();



auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(console.error);

/* ============================ HELPERS ============================= */

function hourTokenUTC(d=new Date()){
  const y=d.getUTCFullYear();
  const m=String(d.getUTCMonth()+1).padStart(2,'0');
  const day=String(d.getUTCDate()).padStart(2,'0');
  const h=String(d.getUTCHours()).padStart(2,'0');
  return `${y}${m}${day}${h}`;
}
async function sha256Hex(txt){
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(txt));
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
}
function takeKey6FromHex(hex){
  const map='0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  let out=''; for(let i=0;i<hex.length && out.length<6;i++){ out+=map[parseInt(hex[i],16)%map.length]; }
  return out.toUpperCase();
}
async function computeHourlyKey(seed, date){ return takeKey6FromHex(await sha256Hex(String(seed)+hourTokenUTC(date))); }
async function getSeed(roomId){
  const s = await db.ref('roomKeySeed/'+roomId).get();
  if (s.exists()) return String(s.val());
  const s2 = await db.ref('roomkeySeed/'+roomId).get();   // eski ad toleransı
  return s2.exists()? String(s2.val()) : '';
}
// key'i şu saat VE bir önceki saat için kabul et (±1h tolerans)

async function verifyQrKey(roomId, provided){
  const seed = await getSeed(roomId);
  if(!seed || !provided) return false;
  const now = new Date();
  const cand = [ new Date(now.getTime()-3600e3), now, new Date(now.getTime()+3600e3) ];
  for (const d of cand){
    if (await computeHourlyKey(seed,d) === String(provided).toUpperCase()) return true;
  }
  return false;
}


/* URL’den auto/act/key yakala ve doğrulanırsa attendance yaz */
async function runAutoActionIfAny(){
  const isAuto = qp('auto');
  const act = qp('act');
  const key = qp('key');
  if(!isAuto || !act || !key) return;

  const ALLOWED = new Set(['enter','exit','break_start','break_end']);
  if(!ALLOWED.has(act)){
    opMsg('Geçersiz eylem: '+act, 'err'); return;
  }

  try{
    const ok = await verifyQrKey(room, key);
    if(!ok){ opMsg('QR anahtarı geçersiz veya süresi dolmuş.', 'err'); return; }

    // kullanıcı girişli mi? (requireLogin yönlendirmeyi artık URL’i koruyarak yapıyor)
    await requireLogin();

    await writeAttendance(act);
    setPresence(act!=='exit');  // küçük UX: hemen rozeti güncelle
    opMsg(`✔ ${act} kaydedildi (QR)`, 'ok');
    toast('QR okundu, işlem kaydedildi ✅', true);
  }catch(e){
    console.error(e);
    opMsg('QR işleminde hata.', 'err');
  }
}


const $ = id => document.getElementById(id);
const qp = n => { try{ return new URL(location.href).searchParams.get(n); }catch(_){ return null; } };
const fmt = ts => new Date(ts||0).toLocaleString('tr-TR');
const fmtTRY = v => new Intl.NumberFormat('tr-TR', {style:'currency', currency:'TRY'}).format(+v||0);
function toast(text, ok){
  try{
    const el = document.createElement('div');
    el.textContent = text;
    el.style.cssText = 'position:fixed;left:50%;top:16px;transform:translateX(-50%);padding:10px 14px;border-radius:10px;font-weight:800;z-index:99999;background:'+(ok?'#0c2019':'#220d0d')+';color:'+(ok?'#62d29a':'#ff8a8a')+';border:1px solid '+(ok?'#2a533f':'#5b2a2a')+';box-shadow:0 10px 30px #0007;';
    document.body.appendChild(el); setTimeout(()=>el.remove(), 2200);
  }catch(_){}
}
function opMsg(msg, type='muted'){ const el=$('opStatus'); if(!el) return; el.className='statusline '+type; el.textContent=msg||''; }
function waitAuth(){ return new Promise(res=>{ const u=auth.currentUser; if(u) return res(u); const off=auth.onAuthStateChanged(x=>{off();res(x)}); }); }
async function requireLogin(){
  const u = await waitAuth();
  if(!u){
    // ÖNCEKİ: login.html?next=panel.html  (parametreleri kaybediyordu)
    location.replace('login.html?next=' + encodeURIComponent(location.href));
    throw new Error('Oturum yok');
  }
  return u;
}

async function computeKey(seed, date){ return takeKey6FromHex(await sha256Hex(seed + hourTokenUTC(date))); }

async function handleAutoFromQR(){
  try{
    if(qp('auto')!=='1') return;
    const act = qp('act');                      // enter | exit | break_start | break_end
    const key = (qp('key')||'').toUpperCase();
    const okActs = new Set(['enter','exit','break_start','break_end']);
    if(!okActs.has(act)){ opMsg('Geçersiz QR aksiyonu','err'); return; }

    const roomId = room; // mevcut değişkeni kullanıyoruz
    const valid = await verifyQrKey(roomId, key);
    if(!valid){ opMsg('QR anahtarı geçersiz/timeout','err'); return; }

    const u = await requireLogin();             // login değilse login.html’e yönlendirilir
    await writeAttendance(act, { method:'qr' }); // kayıt iki indexe de yazılıyor
    setPresence(act!=='exit');                  // anlık UI
    opMsg(`QR ile ${act.replace('_',' ')} kaydedildi ✅`, 'ok');
    toast('Kayıt alındı', true);
  }catch(e){
    console.error(e); opMsg('QR işlemi başarısız','err');
  }
}


// QR-çıkışta geri adımı engellemek için global bayrak
window.__requireExitFb = false;

// Esc veya backdrop tıklamasıyla kapanmayı blokla (gerekiyorsa)
const __exitDlg = document.getElementById('exitDlg');
if (__exitDlg) {
  __exitDlg.addEventListener('cancel', (e)=>{
    if (window.__requireExitFb) e.preventDefault();
  });
}


/* ============================ ROOM SETUP ========================== */
const DEFAULT_ROOM = 'ieeeoda';
const room = qp('room') || DEFAULT_ROOM;
$('roomPill').textContent = `Oda: ${room}`;

/* =========================== UI WIRING ============================ */
const openers = { openAct:'actDlg', openRes:'resDlg', openSched:'schedDlg', openInv:'invDlg', openLogs:'logsDlg', openInvcs:'invcsDlg', openDues:'duesDlg', openTime:'timeDlg' };
Object.entries(openers).forEach(([btnId, dlgId])=>{
  const btn=$(btnId), dlg=$(dlgId);
  if(btn && dlg){ btn.addEventListener('click', ()=> dlg.showModal()); }
});
document.querySelectorAll('[data-close]').forEach(x=> x.addEventListener('click', ()=>{ const id=x.getAttribute('data-close'); $(id)?.close(); }));
$('actClose')?.addEventListener('click', ()=> $('actDlg')?.close());

/* ===================== PRESENCE & TIMELINE ======================== */
const presenceEl = $('presence');
function setPresence(inRoom){
  if(!presenceEl) return;
  presenceEl.className = 'presence ' + (inRoom?'in':'out');
  presenceEl.textContent = inRoom ? 'İçeridesin' : 'Dışarıdasın';
  const eBtn = $('enterBtn'), xBtn = $('exitBtn');
  if(eBtn) eBtn.disabled = inRoom;
  if(xBtn) xBtn.disabled = !inRoom;
}
async function fetchRows(uid, since){
  try{
    const s = await db.ref(`attendanceByUser/${uid}`).orderByChild('createdAt').startAt(since).get();
    return Object.values(s.val()||{});
  }catch(_){
    const s2 = await db.ref(`attendanceByUser/${uid}`).limitToLast(1000).get();
    return Object.values(s2.val()||{}).filter(r => (r.createdAt||0)>=since);
  }
}
let liveTimer=null;
async function hydratePresenceAndStats(uid){
  const since = Date.now() - 30*86400000;
  const rows = (await fetchRows(uid, since)).sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));
  let inside=false, lastEnter=null;
  for(const r of rows){
    if(r.roomId!==room) continue;
    if(r.action==='enter'){ inside=true; lastEnter=r.createdAt; }
    if(r.action==='exit'){ inside=false; lastEnter=null; }
  }
  setPresence(inside);
  const myLast = [...rows].reverse().find(r=>r.roomId===room);
  $('lastAction').textContent = myLast ? `${myLast.action} @ ${fmt(myLast.createdAt)}` : '—';
  renderTodaySum(rows, inside, lastEnter);
  renderTimeline(rows);
}
function renderTodaySum(allRows, insideNow, lastEnter){
  const startOfDay = new Date(); startOfDay.setHours(0,0,0,0);
  const today = (allRows||[]).filter(r=>r.roomId===room && (r.createdAt||0)>=startOfDay.getTime()).sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));
  let total=0, openStart=null;
  for(const r of today){
    if(r.action==='enter') openStart=r.createdAt;
    if(r.action==='exit' && openStart){ total += (r.createdAt - openStart); openStart=null; }
  }
  if(insideNow && (openStart||lastEnter)) total += (Date.now() - (openStart||lastEnter));
  const show = ms => {
    const h = Math.floor(ms/3600000), m = Math.floor((ms%3600000)/60000), s = Math.floor((ms%60000)/1000);
    $('sumToday').textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  };
  show(total);
  if(liveTimer) clearInterval(liveTimer);
  if(insideNow){
    const start = (openStart||lastEnter||Date.now());
    liveTimer = setInterval(()=> show(total + (Date.now()-start)), 1000);
  }
}
function renderTimeline(allRows){
  const startOfDay = new Date(); startOfDay.setHours(0,0,0,0);
  const dayStart = startOfDay.getTime(), dayEnd = dayStart + 86400000;
  const rows = (allRows||[]).filter(r=>r.roomId===room && (r.createdAt||0)>=dayStart).sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));
  const container=$('timeline'); if(!container) return; container.innerHTML='';
  let open=null, segs=[];
  rows.forEach(r=>{ if(r.action==='enter') open=r.createdAt; if(r.action==='exit'&&open){ segs.push([open,r.createdAt]); open=null; } });
  if(open) segs.push([open, Date.now()]);
  segs.forEach(([s,e])=>{
    const l = Math.max(0, (s-dayStart)/(dayEnd-dayStart)*100);
    const w = Math.max(0.5, (e-s)/(dayEnd-dayStart)*100);
    const b=document.createElement('div');
    b.style.position='absolute'; b.style.left=l+'%'; b.style.width=w+'%'; b.style.top='0'; b.style.bottom='0';
    b.style.background='linear-gradient(90deg,var(--pri),var(--pri-2))'; b.style.borderRadius='999px';
    container.appendChild(b);
  });
  const totalMs = segs.reduce((a,[s,e])=>a+(e-s),0);
  const h = Math.floor(totalMs/3600000), m = Math.floor((totalMs%3600000)/60000);
  $('timelineLegend').textContent = segs.length ? `Toplam: ${h} sa ${m} dk (blok: ${segs.length})` : 'Bugün kayıt yok';
}

/* ====================== LOGS (Kayıtlarım) ========================= */
let myLogUnsub = null;
function attachMyLog(uid){
  const ref = db.ref(`attendanceByUser/${uid}`).limitToLast(40);
  if (myLogUnsub) ref.off('value', myLogUnsub);
  myLogUnsub = ref.on('value', snap=>{
    const tbody = $('myRows'); if(!tbody) return; tbody.innerHTML='';
    const rows = Object.values(snap.val()||{}).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    tbody.innerHTML = rows.map(r=>`<tr><td>${fmt(r.createdAt||0)}</td><td>${r.action}</td><td>${r.roomId}</td><td>${r.method||''}</td></tr>`).join('');
  });
}

/* ======================== MANUAL ACTIONS ========================== */
let writing=false;
async function writeAttendance(action, extra={}){
  if(writing) return; writing=true;
  try{
    const u = await requireLogin();
    const pushId = db.ref().child('attendanceByUser').push().key;
    const rec = { userId:u.uid, userName:u.displayName||u.email||'unknown', roomId:room, action, createdAt: firebase.database.ServerValue.TIMESTAMP, ua:navigator.userAgent||'', method:'panel', ...extra };
    const updates = {};
    updates[`/attendanceByUser/${u.uid}/${pushId}`] = rec;
    updates[`/attendanceByRoom/${room}/${pushId}`]  = rec;
    await db.ref().update(updates);
    await hydratePresenceAndStats(u.uid);
  } finally { writing=false; }
}
$('enterBtn')?.addEventListener('click', async ()=>{
  const btn=$('enterBtn'); const old=btn.innerHTML; btn.disabled=true; btn.innerHTML=old+' <span class="spinner"></span>';
  try{ await writeAttendance('enter'); opMsg('Giriş kaydedildi','ok'); setPresence(true); } finally{ btn.disabled=false; btn.innerHTML=old; }
});
$('exitBtn')?.addEventListener('click', ()=> $('exitDlg').showModal());
$('breakStartBtn')?.addEventListener('click', async ()=>{
  const btn=$('breakStartBtn'); const old=btn.innerHTML; btn.disabled=true; btn.innerHTML=old+' <span class="spinner"></span>';
  try{ await writeAttendance('break_start'); opMsg('Mola başlatıldı','ok'); } finally{ btn.disabled=false; btn.innerHTML=old; }
});
$('breakEndBtn')?.addEventListener('click', async ()=>{
  const btn=$('breakEndBtn'); const old=btn.innerHTML; btn.disabled=true; btn.innerHTML=old+' <span class="spinner"></span>';
  try{ await writeAttendance('break_end'); opMsg('Mola bitti','ok'); } finally{ btn.disabled=false; btn.innerHTML=old; }
});

/* ================== EXIT DIALOG (stars/tags/people) =============== */
const statusSeg = $('statusSeg'); let fbStatusVal='clean';
if(statusSeg){
  statusSeg.querySelectorAll('.chip').forEach(ch=>{
    if(ch.dataset.val==='clean') ch.classList.add('active');
    ch.addEventListener('click', ()=>{
      statusSeg.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
      ch.classList.add('active'); fbStatusVal=ch.dataset.val;
    });
  });
}
const starEl=$('stars'); let rating=0;
if(starEl){ [...starEl.children].forEach((s,i)=> s.addEventListener('click', ()=>{ rating=i+1; [...starEl.children].forEach((x,k)=> x.classList.toggle('on', k<rating)); })); }
const activeTags=new Set();
document.querySelectorAll('.tag').forEach(t=> t.addEventListener('click', ()=>{ const k=t.dataset.tag; activeTags.has(k)?(activeTags.delete(k),t.classList.remove('active')):(activeTags.add(k),t.classList.add('active')); }));
const withBox=$('withBox'), withInput=$('withInput');
function addPerson(raw){
  const name=(raw||'').replace(/,/g,' ').trim(); if(!name) return;
  const exists=[...withBox.querySelectorAll('.person')].some(n=>n.textContent.toLowerCase()===name.toLowerCase());
  if(exists){ withInput.value=''; return; }
  const chip=document.createElement('span'); chip.className='chip person'; chip.textContent=name; chip.title='Kaldır'; chip.onclick=()=>chip.remove();
  withBox.insertBefore(chip, withInput); withInput.value='';
}
withInput?.addEventListener('keydown', e=>{
  if(e.key==='Enter'||e.key===','){ e.preventDefault(); addPerson(withInput.value); }
  if(e.key==='Backspace'&&!withInput.value){ const last=withBox.querySelector('.person:last-of-type'); last&&last.remove(); }
});
withInput?.addEventListener('blur', ()=> addPerson(withInput.value));

/* ========================= CAMERA DIALOG ========================== */
let __camStream=null, photoDataUrl='';
const camDlg=$('camDlg'), camVideo=$('camVideo'), camCanvas=$('camCanvas'), exitPreview=$('exitPreview'), photoStatus=$('photoStatus');
async function startCamera(){
  try{
    __camStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:720} }, audio:false });
    camVideo.srcObject = __camStream; await camVideo.play();
  }catch(e){ alert('Kamera açılamadı. Tarayıcı izinlerini kontrol et.'); stopCamera(); camDlg?.close(); }
}
function stopCamera(){ if(__camStream){ __camStream.getTracks().forEach(t=>t.stop()); __camStream=null; } if(camVideo) camVideo.srcObject=null; }
$('openCam')?.addEventListener('click', ()=>{ photoDataUrl=''; camDlg.showModal(); startCamera(); });
$('camCancel')?.addEventListener('click', ()=>{ stopCamera(); camDlg.close(); });
$('camShoot')?.addEventListener('click', ()=>{
  try{
    const vw=camVideo.videoWidth, vh=camVideo.videoHeight; if(!vw||!vh) return;
    const maxW=1024, maxH=768; const ratio=Math.min(maxW/vw,maxH/vh,1);
    const w=Math.round(vw*ratio), h=Math.round(vh*ratio);
    camCanvas.width=w; camCanvas.height=h; const ctx=camCanvas.getContext('2d'); ctx.drawImage(camVideo,0,0,w,h);
    photoDataUrl = camCanvas.toDataURL('image/jpeg', .72);
    exitPreview.src = photoDataUrl; exitPreview.style.display='inline-block'; photoStatus.textContent='Kameradan fotoğraf çekildi.';
  }catch{ alert('Fotoğraf çekilemedi.'); }
  finally{ stopCamera(); camDlg.close(); }
});

/* ========================= FEEDBACK SEND ========================== */
$('fbCancel')?.addEventListener('click', ()=> $('exitDlg').close());
$('fbSend')?.addEventListener('click', async ()=>{
  const btn=$('fbSend'); const old=btn.innerHTML; btn.disabled=true; btn.innerHTML=old+' <span class="spinner"></span>';

  // === ZORUNLU ALAN DOĞRULAMA ===
  const commentEl = $('fbComment');
  // yıldız puanı "rating" değişkeninde tutuluyor (senin koddaki global)
  const needStrict = !!window.__requireExitFb;     // yalnız QR-exit’te zorunlu

  // alanları temizle (önceki invalid class’ı kaldır)
  commentEl?.classList.remove('invalid');
  if (starEl) [...starEl.children].forEach(x=> x.style.outline='');

  if (needStrict) {
    const comm = (commentEl?.value || '').trim();
    const hasRating = (typeof rating==='number' && rating>=1);
    let fail = false;

    if (!hasRating) {
      // yıldızlara hafif outline
      if (starEl) [...starEl.children].forEach(x=> x.style.outline='2px solid #c62828');
      fail = true;
    }
    if (!comm) {
      commentEl?.classList.add('invalid');
      fail = true;
    }

    if (fail) {
      btn.disabled=false; btn.innerHTML=old;
      toast('Lütfen puan ver ve kısa bir yorum yaz ✍️', false);
      opMsg('Yorum/puan zorunlu (QR çıkış).', 'err');
      return;
    }
  }

  try{
    const u = await requireLogin();
    const comment = $('fbComment').value.trim();
    const tags = Array.from(activeTags);
    const people = [...withBox.querySelectorAll('.person')].map(x=>x.textContent);
    const fbRef = db.ref(`roomFeedback/${room}`).push();
    await fbRef.set({
      userId:u.uid, userName:u.displayName||u.email||'unknown',
      status:fbStatusVal, rating, comment, tags, withPeople:people,
      photoB64:photoDataUrl||'', createdAt: Date.now()
    });

    // QR-exit akışında: exit kaydını şimdi yaz
    if (window.__requireExitFb) {
      await writeAttendance('exit', { feedbackId: fbRef.key, method:'qr' });
      setPresence(false);
      opMsg('Çıkış + yorum kaydedildi (QR).','ok');
    } else {
      await writeAttendance('exit', { feedbackId: fbRef.key });
      setPresence(false);
      opMsg('Çıkış + yorum kaydedildi.','ok');
    }

    // formu sıfırla (senin mevcut reset bloğun)
    $('fbComment').value='';
    activeTags.clear(); document.querySelectorAll('.tag').forEach(t=>t.classList.remove('active'));
    statusSeg?.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
    statusSeg?.querySelector('[data-val="clean"]')?.classList.add('active'); fbStatusVal='clean';
    rating=0; [...(starEl?.children||[])].forEach(x=>{ x.classList.remove('on'); x.style.outline=''; });
    [...withBox.querySelectorAll('.person')].forEach(x=>x.remove()); withInput.value='';
    if(exitPreview) exitPreview.style.display='none'; if(photoStatus) photoStatus.textContent='';
    photoDataUrl='';

    // kilitleri kaldır ve modalı kapat
    window.__requireExitFb = false;
    document.getElementById('fbCancel')?.removeAttribute('disabled');
    $('exitDlg').close();

  }catch(e){
    console.error(e); opMsg('Gönderilemedi.','err');
  } finally {
    btn.disabled=false; btn.innerHTML=old;
  }
});


/* ========================= RESERVATIONS =========================== */
function attachReservations(roomId, uid){
  const now = Date.now(), soon = now + 30*86400000;
  db.ref(`roomReservations/${roomId}`).orderByChild('startAt').startAt(now).endAt(soon).on('value', s=>{
    const rows = Object.values(s.val()||{}).sort((a,b)=>(a.startAt||0)-(b.startAt||0));
    const tb = $('resRows'); if(!tb) return;
    tb.innerHTML = rows.length ? rows.map(r=>`
      <tr>
        <td>${new Date(r.startAt).toLocaleString('tr-TR')} – ${new Date(r.endAt).toLocaleTimeString('tr-TR')}</td>
        <td>${r.title||''}</td>
        <td><span class="pill">${(r.status||'pending')}</span></td>
      </tr>`).join('') : `<tr><td colspan="3" class="muted">Yaklaşan rezervasyon yok</td></tr>`;
  });
}
async function reserveAtomic(roomId, payload){
  const { startAt, endAt } = payload;
  if(!startAt || !endAt || endAt<=startAt) throw new Error('Geçersiz zaman');
  const slotKey = `${startAt}-${endAt}`;
  const lockRef = db.ref(`roomReservationsLock/${roomId}/${slotKey}`);
  const txn = await lockRef.transaction(v => v ? v : true, false, false);
  if (!txn.committed || txn.snapshot.val() !== true) throw new Error('Bu aralık şu an meşgul (kilit alınamadı).');
  try{
    const ref = db.ref(`roomReservations/${roomId}`).push();
    const rec = { id: ref.key, roomId, userId: payload.userId, userName: payload.userName, title: payload.title, note: payload.note||'', startAt, endAt, status:'pending', createdAt: Date.now() };
    await ref.set(rec);
    await db.ref(`userReservations/${payload.userId}/${ref.key}`).set(rec);
    return ref.key;
  }catch(e){ await lockRef.remove(); throw e; }
}
['resTitle','resStart','resEnd'].forEach(id=>{
  $(id)?.addEventListener('input', ()=>{
    const ok = $('resTitle').value.trim() && $('resStart').value && $('resEnd').value;
    $('resSend').disabled = !ok;
  });
});
$('resSend')?.addEventListener('click', async ()=>{
  const show = (txt, cls='muted') => { const el=$('resStatus'); el.className='statusline '+cls; el.textContent=txt; };
  try{
    const u = await requireLogin();
    const title = $('resTitle').value.trim();
    const start = $('resStart').value ? new Date($('resStart').value).getTime() : 0;
    const end   = $('resEnd').value   ? new Date($('resEnd').value).getTime()   : 0;
    const note  = $('resNote').value.trim();
    if(!title || !start || !end || end<=start){ show('Başlık ve geçerli zaman aralığı girin.','err'); return; }
    $('resSend').disabled=true; show('Gönderiliyor…');
    const id = await reserveAtomic(room, { userId:u.uid, userName:u.displayName||u.email||'unknown', title, note, startAt:start, endAt:end });
    show('Talep iletildi. Karar güncellendiğinde burada görünecek.','ok');
    const checkRef = db.ref(`roomReservations/${room}/${id}`);
    const off = checkRef.on('value', s=>{
      const v=s.val()||{}; if(v.status && v.decisionNote){ show(`Durum: ${v.status} (${v.decisionNote})`, v.status==='approved'?'ok':(v.status==='declined'?'err':'warn')); checkRef.off('value', off); }
    });
    $('resTitle').value=''; $('resStart').value=''; $('resEnd').value=''; $('resNote').value=''; $('resSend').disabled=true;
  }catch(e){ console.error(e); show(e.message||'Gönderilemedi','err'); }
});




/* ========================= DASHBOARD ============================== */
/* — Yaklaşan 5 rezervasyon + içerideki kişi sayısı/listesi — */
function formatTimeRange(s, e){
  const d1=new Date(s), d2=new Date(e);
  const gun = d1.toLocaleDateString('tr-TR', {weekday:'short', day:'2-digit', month:'short'});
  const hhmm = t => new Date(t).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});
  return `${gun} ${hhmm(s)}–${hhmm(e)}`;
}
function attachDashboard(roomId){
  /* Yaklaşan rezervasyonlar (ilk 5) */
  const upRef = db.ref(`roomReservations/${roomId}`)
                 .orderByChild('startAt').startAt(Date.now()).limitToFirst(5);
  upRef.on('value', s=>{
    const ul = $('dashUpcoming'); if(!ul) return;
    const rows = Object.values(s.val()||{}).sort((a,b)=>(a.startAt||0)-(b.startAt||0));
    if(!rows.length){ ul.innerHTML = '<li class="muted">Yaklaşan rezervasyon yok</li>'; return; }
    ul.innerHTML = rows.map(r=>{
      const t = formatTimeRange(r.startAt, r.endAt);
      const st = (r.status||'pending');
      return `<li><strong>${r.title||'Rezerve'}</strong> — ${r.userName||'—'} <span class="muted">(${t})</span> <span class="pill" style="margin-left:6px">${st}</span></li>`;
    }).join('');
  });

  /* İçerideki kişi sayısı: son kayıtlarına göre enter/exit durumu */
  const occRef = db.ref(`attendanceByRoom/${roomId}`).limitToLast(1000);
  const renderOcc = (list)=>{
    const byUser = new Map(); // userId -> {state:'in'|'out', name}
    const rows = list.sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));
    for(const r of rows){
      if(!r.userId) continue;
      if(r.action==='enter') byUser.set(r.userId, {state:'in',  name:r.userName||r.userId});
      else if(r.action==='exit') byUser.set(r.userId, {state:'out', name:r.userName||r.userId});
      // break_* kayıtları sayacı etkilemesin
    }
    const inside = [...byUser.values()].filter(v=>v.state==='in');
    const occ = inside.length;

    // pill güncelle
    const pill = $('occPill'); if(pill){ pill.textContent = `👥 ${occ}`; pill.title = `Şu an içeride: ${occ} kişi`; }

    // liste + özet
    const ul = $('dashOccList'), lg = $('dashOccLegend');
    if(!ul || !lg) return;
    if(!occ){
      lg.textContent = 'İçeride kimse yok';
      ul.innerHTML = '<li class="muted">—</li>';
    }else{
      lg.textContent = `Toplam ${occ} kişi içeride`;
      ul.innerHTML = inside
        .sort((a,b)=>a.name.localeCompare(b.name,'tr'))
        .map(v=>`<li>${v.name}</li>`).join('');
    }
  };
  // İlk doldurma + canlı dinleme
  occRef.on('value', s=>{
    const vals = Object.values(s.val()||{});
    renderOcc(vals);
  });
}


function statusBusyLike(st){
  st = String(st||'').toLowerCase();
  if (['approved','accepted','ok'].includes(st)) return 'busy';
  if (['pending','waiting','review'].includes(st)) return 'warn';
  if (['declined','rejected','cancelled','canceled'].includes(st)) return 'free';
  // bilinmeyen durumları temkinli yorumlayalım
  return 'busy';
}

function humanTimeHM(ts){
  return new Date(ts).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});
}

function attachRoomAvailability(roomId){
  const ref = db.ref(`roomReservations/${roomId}`);
  const pill = document.getElementById('availPill');
  if(!pill) return;

  function render(nowList){
    const now = Date.now();

    // şu anla çakışan rezervasyonlar
    const overlaps = nowList.filter(r => (r.startAt||0) <= now && now < (r.endAt||0));
    // sonraki rezervasyon (bilgi amaçlı)
    const upcoming = nowList
      .filter(r => (r.startAt||0) > now)
      .sort((a,b)=>(a.startAt||0)-(b.startAt||0))[0];

    if (overlaps.length){
      // birden fazla varsa en "sert" statüyü göster
      // öncelik: approved > pending > diğer
      let flag = 'warn', chosen = overlaps[0];
      for (const r of overlaps){
        const s = statusBusyLike(r.status);
        if (s === 'busy'){ flag = 'busy'; chosen = r; break; }
        if (s === 'warn'){ flag = 'warn'; chosen = r; } // olası alternatif
      }
      pill.className = `pill avail-${flag}`;
      const until = humanTimeHM(chosen.endAt);
      const title = `${chosen.title || 'Rezerve'} — ${chosen.userName || '—'} (${humanTimeHM(chosen.startAt)}–${humanTimeHM(chosen.endAt)})`;
      pill.textContent = flag==='busy' ? `Rezerve (bit.: ${until})` : `Beklemede (bit.: ${until})`;
      pill.title = title;
      return;
    }

    // çakışan yok → boş/müsait
    pill.className = 'pill avail-free';
    if (upcoming){
      pill.textContent = `Müsait (sonraki: ${humanTimeHM(upcoming.startAt)})`;
      pill.title = `${upcoming.title || 'Rezervasyon'} — ${upcoming.userName || '—'} (${humanTimeHM(upcoming.startAt)}–${humanTimeHM(upcoming.endAt)})`;
    }else{
      pill.textContent = 'Müsait';
      pill.title = 'Yaklaşan rezervasyon yok';
    }
  }

  // canlı dinle
  const cb = snap => {
    const list = Object.values(snap.val()||{});
    render(list);
  };
  ref.on('value', cb);

  // zaman ilerledikçe slot sınırı değiştiği için her dakikada bir tetikleyelim
  setInterval(async ()=>{
    const s = await ref.get();
    const list = Object.values(s.val()||{});
    render(list);
  }, 60 * 1000);
}






/* ========================= DAILY SCHEDULE ========================= */
let _schedUnsub=null;
function dayRange(ts){ const d=new Date(ts); d.setHours(0,0,0,0); const start=d.getTime(); return {start, end:start+86400000}; }
function buildSlots(dayStart){ const out=[]; let t=dayStart; for(let i=0;i<48;i++){ const hh=String(new Date(t).getHours()).padStart(2,'0'); const mm=String(new Date(t).getMinutes()).padStart(2,'0'); out.push({t,label:`${hh}:${mm}`}); t+=1800000; } return out; }
function statusClass(s){ s=(s||'pending').toLowerCase(); if(['approved','ok','accepted'].includes(s)) return 'slot-approved'; if(['declined','rejected'].includes(s)) return 'slot-declined'; return s==='pending' ? 'slot-pending' : 'slot-pending'; }
function human(name, fb='—'){ return String(name||'').trim() || fb; }
function attachSchedule(roomId){
  const dateInp=$('schedDate'), tbody=$('schedRows'); if(!dateInp || !tbody) return;
  const d=new Date(); dateInp.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  async function listenDay(){
    if(_schedUnsub && typeof _schedUnsub==='function'){ _schedUnsub(); _schedUnsub=null; }
    const day = new Date(dateInp.value+'T00:00:00'); if(isNaN(day.getTime())) return;
    const {start,end} = dayRange(day.getTime());
    const ref = db.ref(`roomReservations/${roomId}`).orderByChild('startAt').startAt(start).endAt(end);
    const cb = snap => {
      const list = Object.values(snap.val()||{}).sort((a,b)=>(a.startAt||0)-(b.startAt||0));
      renderSchedule(list, start);
    };
    ref.on('value', cb); _schedUnsub = ()=> ref.off('value', cb);
  }
  function renderSchedule(resList, dayStart){
    tbody.innerHTML=''; const slots = buildSlots(dayStart);
    for(const s of slots){
      const slotStart=s.t, slotEnd=s.t+1800000;
      const hit = resList.find(r => !((r.endAt||0)<=slotStart || (r.startAt||0)>=slotEnd));
      const tr=document.createElement('tr');
      const tdTime=document.createElement('td'); tdTime.textContent=s.label; tdTime.className='slot-cell';
      const tdState=document.createElement('td'); const tdInfo=document.createElement('td');
      if(hit){
        const st=statusClass(hit.status);
        tdState.innerHTML = `<span class="${st}">${(hit.status||'pending')}</span>`;
        tdInfo.innerHTML  = `<strong>${human(hit.title,'Rezerve')}</strong> — ${human(hit.userName)}${hit.note? ` <span class="muted">(${hit.note.slice(0,60)})</span>`:''}`;
      }else{
        tdState.innerHTML = `<span class="slot-free">Boş</span>`;
        tdInfo.innerHTML  = `<span class="slot-click" data-start="${slotStart}" data-end="${slotEnd}">Bu slota rezervasyon iste</span>`;
      }
      tr.appendChild(tdTime); tr.appendChild(tdState); tr.appendChild(tdInfo); tbody.appendChild(tr);
    }
    tbody.querySelectorAll('.slot-click').forEach(a=>{
      a.addEventListener('click', ()=>{
        const s = Number(a.getAttribute('data-start')), e = Number(a.getAttribute('data-end'));
        const toIso = ms => new Date(ms - (new Date().getTimezoneOffset()*60000)).toISOString().slice(0,16);
        const startInp=$('resStart'), endInp=$('resEnd');
        if(startInp && endInp){
          startInp.value=toIso(s); endInp.value=toIso(e);
          $('resDlg')?.showModal(); $('resTitle')?.focus(); toast('Slot seçildi: form dolduruldu', true);
          $('resSend').disabled = !($('resTitle').value.trim() && $('resStart').value && $('resEnd').value);
        }
      });
    });
  }
  dateInp.addEventListener('change', listenDay);
  listenDay();
}


// ---- QR auto-flow (TEK handler) ----
let qrHandled = false;
async function processQrAutoOnce(){
  if (qrHandled) return;
  const auto = qp('auto');                // '1' beklemeyelim; var olması yeter
  const act  = qp('act');
  const key  = (qp('key')||'').toUpperCase();
  if(!auto || !act || !key) return;

  const okActs = new Set(['enter','exit','break_start','break_end']);
  if(!okActs.has(act)){ opMsg('Geçersiz QR aksiyonu','err'); return; }

  const valid = await verifyQrKey(room, key);
  if(!valid){ opMsg('QR anahtarı geçersiz / süresi dolmuş','err'); return; }

  const u = await requireLogin();
  
  if (act === 'exit') {
    window.__requireExitFb = true;
    document.getElementById('fbCancel')?.setAttribute('disabled','disabled'); // vazgeçi kilitle
    document.getElementById('exitDlg')?.showModal();
    toast('Çıkış QR okundu. Lütfen kısa bir yorum bırak 🙏', false);
    opMsg('QR çıkış algılandı: yorum gerekli', 'warn');
    qrHandled = true;        // aynı URL ile tekrar çalışmasın
    return;                  // BURADA BİTİR — exit kaydını fbSend yapacak
  }

  // login değilse aynı URL ile geri döner
  await writeAttendance(act, { method:'qr' });  // KAYIT
  await hydratePresenceAndStats(u.uid);         // Durumu hesapla (enter/exit’e göre)
  setPresence(act!=='exit');                    // anlık badge
  toast('QR kaydı alındı ✅', true);
  opMsg(`QR ile ${act.replace('_',' ')} kaydedildi`, 'ok');

  qrHandled = true;
}

/* ============================ DUES ================================ */
function ymNow(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
{
  // *** HATA YAPAN SATIRIN DÜZELTİLMİŞ HALİ ***
  const duesMonthEl = $('duesMonth');
  if (duesMonthEl && !duesMonthEl.value) duesMonthEl.value = ymNow();
}
['duesMonth','duesAmount'].forEach(id=>{
  $(id)?.addEventListener('input', ()=>{
    const ok = ($('duesMonth').value||'').trim() && Number.isFinite(parseFloat(($('duesAmount').value||'').trim()));
    $('duesSend').disabled = !ok;
  });
});
$('duesSend')?.addEventListener('click', async ()=>{
  const btn=$('duesSend'); const old=btn.innerHTML; btn.disabled=true; btn.innerHTML=old+' <span class="spinner"></span>';
  try{
    const u = await requireLogin();
    const month = ($('duesMonth').value||'').trim() || ymNow();
    const amt = parseFloat(($('duesAmount').value||'').trim());
    if(!(amt>=0)){ $('duesStatus').className='statusline err'; $('duesStatus').textContent='Geçerli tutar gir.'; return; }
    const ref = db.ref(`duesPayments/${u.uid}`).push();
    const rec = { id: ref.key, userId:u.uid, userName:u.displayName||u.email||'unknown', amount:+(amt||0), month, status:'pending', createdAt: Date.now() };
    await ref.set(rec);
    await db.ref(`duesPaymentsIndex/${ref.key}`).set(rec);
    $('duesStatus').className='statusline ok'; $('duesStatus').textContent='Aidat bildirimin gönderildi (onay bekliyor).';
  }catch(e){ console.error(e); $('duesStatus').className='statusline err'; $('duesStatus').textContent='Gönderilemedi (yetki/bağlantı hatası).'; }
  finally{ btn.disabled=false; btn.innerHTML=old; }
});

/* ======= Fatura (PDF) ========= */
function hasInvoiced(id){ try{ return JSON.parse(localStorage.getItem('invoices_done')||'{}')[id]; }catch{ return false; } }
function markInvoiced(id){ const m=JSON.parse(localStorage.getItem('invoices_done')||'{}'); m[id]=true; localStorage.setItem('invoices_done', JSON.stringify(m)); }
function makeInvoiceNo(rec){ const d=new Date(rec.createdAt||Date.now()); const y=d.getFullYear(); const short=(rec.id||'xxxxxx').slice(-6).toUpperCase(); return `IEEE-${y}-${short}`; }
async function generateInvoicePdf(rec, user){
  const { jsPDF } = window.jspdf || {}; if(!jsPDF){ alert('PDF kütüphanesi yok'); return; }
  const doc = new jsPDF({ unit:'pt', format:'a4' }), pageW = doc.internal.pageSize.getWidth(), margin=48;
  doc.setFillColor(10,124,193); doc.rect(0,0,pageW,72,'F');
  doc.setTextColor(255,255,255); doc.setFont('helvetica','bold'); doc.setFontSize(18); doc.text('IEEE IKCU TechOps', margin, 42);
  doc.setFont('helvetica','normal'); doc.setFontSize(12); doc.text('Aidat / Fatura Belgesi', margin, 60);
  doc.setTextColor(16,36,59);
  const invNo=makeInvoiceNo(rec), issueAt=new Date().toLocaleString('tr-TR'), month=rec.month||'—';
  const boxX = pageW - margin - 220, boxY = 96, boxW = 220, boxH = 84;
  doc.setDrawColor(233,239,248); doc.roundedRect(boxX, boxY, boxW, boxH, 8, 8);
  doc.setFont('helvetica','bold'); doc.text('MAKBUZ', boxX+14, boxY+22);
  doc.setFont('helvetica','normal'); doc.text(`No: ${invNo}`, boxX+14, boxY+42); doc.text(`Tarih: ${issueAt}`, boxX+14, boxY+62);
  const whoY=110; doc.setFont('helvetica','bold'); doc.text('ODEMEYI YAPAN', margin, whoY);
  doc.setFont('helvetica','normal'); doc.text(`${user.displayName || user.email || user.uid}`, margin, whoY+18); if (user.email) doc.text(`${user.email}`, margin, whoY+36);
  const orgY=whoY+64; doc.setFont('helvetica','bold'); doc.text('KURUM', margin, orgY);
  doc.setFont('helvetica','normal'); doc.text('IEEE IKCU Ogrenci Kolu — TechOps', margin, orgY+18); doc.text('Amaç: Aidat tahsilati ve kulup faaliyetleri', margin, orgY+36);
  doc.setDrawColor(233,239,248); doc.line(margin, orgY+56, pageW-margin, orgY+56);
  const itemsY=orgY+84; doc.setFont('helvetica','bold'); doc.text('KALEM', margin, itemsY); doc.text('DONEM', margin+260, itemsY); doc.text('TUTAR', pageW-margin-100, itemsY, {align:'right'});
  doc.setFont('helvetica','normal'); const rowY=itemsY+22; doc.text('Uye Aidati', margin, rowY); doc.text(`${month}`, margin+260, rowY); doc.text(fmtTRY(rec.amount), pageW-margin-100, rowY, {align:'right'});
  const sumY=rowY+36; doc.setDrawColor(233,239,248); doc.line(margin, sumY, pageW-margin, sumY);
  doc.setFont('helvetica','bold'); doc.text('TOPLAM', margin, sumY+22); doc.text(fmtTRY(rec.amount), pageW-margin-100, sumY+22, {align:'right'});
  doc.setTextColor(109,122,144); doc.setFontSize(10); doc.text('© IEEE IKCU TechOps', margin, 820);
  const fname=`ieee-techops-fatura_${month}_${invNo}.pdf`; doc.save(fname);
  try{ await db.ref(`userInvoices/${user.uid}/${rec.id}`).set({ createdAt: Date.now(), title:`Aidat (${month})`, total:+(rec.amount||0), status:'paid', invoiceNo:invNo }); }catch(e){}
}
async function maybeInvoice(uid, rec){
  try{
    if(!rec || rec.userId!==uid) return;
    const ok=(rec.status||'').toLowerCase();
    if(!(ok==='approved'||ok==='received'||ok==='paid')) return;
    if(hasInvoiced(rec.id)) return;
    const u = await waitAuth(); if(!u) return;
    await generateInvoicePdf(rec, u); markInvoiced(rec.id); toast('Fatura indirildi ✅', true);
  }catch(e){ console.error('invoice fail:', e); }
}
function attachDuesApprovalListener(uid){
  const ref = db.ref(`duesPayments/${uid}`);
  ref.on('child_changed', s=> maybeInvoice(uid, { id:s.key, ...s.val() }));
  ref.on('child_added',   s=> maybeInvoice(uid, { id:s.key, ...s.val() }));
}
function attachDuesTable(uid){
  const ref = db.ref(`duesPayments/${uid}`).limitToLast(200);
  ref.on('value', snap=>{
    const tb=$('myInvRows'); if(!tb) return;
    const rows = Object.values(snap.val()||{}).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    tb.innerHTML = rows.length ? rows.map(r=>{
      const canInvoice = ['approved','paid','received'].includes(String(r.status||'').toLowerCase());
      const btn = canInvoice ? `<button class="btn light btn-make-invoice">Fatura oluştur</button>` : `<span class="muted">—</span>`;
      return `<tr data-id="${r.id}"><td>${fmt(r.createdAt)}</td><td>Aidat (${r.month||'—'})</td><td>${fmtTRY(r.amount)}</td><td>${(r.status||'pending')}</td><td>${btn}</td></tr>`;
    }).join('') : `<tr><td colspan="5" class="muted">Fatura yok</td></tr>`;
  });
  $('myInvRows')?.addEventListener('click', async (e)=>{
    const btn=e.target.closest('.btn-make-invoice'); if(!btn) return;
    const tr=btn.closest('tr'); const id=tr?.dataset?.id; if(!id) return;
    try{
      const u = await waitAuth(); const s=await db.ref(`duesPayments/${u.uid}/${id}`).get(); const rec={ id, ...s.val() };
      await generateInvoicePdf(rec, u); toast('Fatura indirildi ✅', true);
    }catch(err){ console.error(err); toast('Fatura oluşturulamadı', false); }
  });
}

/* =========================== LIFECYCLE ============================ */
(async ()=>{
  const u = await waitAuth();
  if(!u){ location.replace('login.html?next='+encodeURIComponent('panel.html')); return; }
  $('hello').textContent = `Merhaba, ${u.displayName || u.email || u.uid}`;
  $('logout')?.addEventListener('click', ()=> auth.signOut().then(()=>location.replace('login.html')));

  attachMyLog(u.uid);
  attachReservations(room, u.uid);
  attachSchedule(room);
  attachDashboard(room);
  attachRoomAvailability(room);
  attachDuesTable(u.uid);
  attachDuesApprovalListener(u.uid);
  await hydratePresenceAndStats(u.uid);
  await processQrAutoOnce();

  window.addEventListener('keydown', e=>{
    if(e.target && /input|textarea|select/i.test(e.target.tagName)) return;
    const k=e.key.toLowerCase();
    if(k==='e'){ $('actDlg')?.showModal(); $('enterBtn')?.click(); }
    else if(k==='x'){ $('actDlg')?.showModal(); $('exitBtn')?.click(); }
    else if(k==='b'){ $('actDlg')?.showModal(); $('breakStartBtn')?.click(); }
    else if(k==='n'){ $('actDlg')?.showModal(); $('breakEndBtn')?.click(); }
    else if(k==='r'){ $('resDlg')?.showModal(); }
  });

  $('resSend').disabled = true;
  $('invSend') && ($('invSend').disabled = true);
  const dm=$('duesMonth'), da=$('duesAmount');
  $('duesSend').disabled = !((dm?.value||'').trim() && Number.isFinite(parseFloat(da?.value||'')));
})();
}); // safeBoot
</script>

</body>
</html>
