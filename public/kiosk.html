<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Oda Ekranı (Kiosk)</title>
<link rel="icon" href="assets/techops.ico" type="image/x-icon"/>
<style>
:root{
  --bg:#0b1118; --card:#0f1a27; --edge:#1f2b3b; --ink:#e8eef6; --muted:#9bb0c8;
  --pri:#2aa3ff; --ok:#62d29a; --err:#ff8a8a; --warn:#ffd27a;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:ui-sans-serif,system-ui,Inter,Roboto,Arial;background:var(--bg);color:var(--ink)}
.wrap{max-width:980px;margin:0 auto;padding:18px}
.top{display:flex;align-items:center;gap:12px;justify-content:space-between;margin:6px 0 14px}
.pill{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;border:1px solid var(--edge);background:#ffffff10;font-weight:800}
.status{display:inline-flex;gap:8px;align-items:center;padding:10px 12px;border-radius:12px;border:1px solid var(--edge);font-weight:900}
.status.ok{color:var(--ok);border-color:#2a533f;background:#0c2019}
.status.reserved{color:#ffd27a;border-color:#5a4b1e;background:#2e240f}
.card{background:linear-gradient(180deg,#0f1a27,#0d1723);border:1px solid var(--edge);border-radius:18px;box-shadow:0 16px 50px #0006;padding:16px}
.grid{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
@media (max-width:820px){ .grid{grid-template-columns:1fr;} }
h2{margin:0 0 6px;font-size:16px;color:var(--muted)}
.muted{color:var(--muted)}
.big{font-size:48px;font-weight:900;letter-spacing:1px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.list{margin:0;padding:0;list-style:none}
.list li{padding:8px 0;border-bottom:1px solid var(--edge)}
.hint{font-size:12px;color:var(--muted)}

/* ==== QR 4’lü düzen (2x2, ferah) ==== */
.qr4{
  display:grid;
  grid-template-columns: repeat(2, minmax(0, 1fr)); /* her zaman 2 sütun */
  gap:28px;              /* kartlar arası boşluk */
  justify-items:center;  /* ortala */
  align-items:start;
}
/* dar mobilde 1 sütun düş */
@media (max-width:720px){
  .qr4{ grid-template-columns: 1fr; }
}

.qrbox{
  width:100%;
  max-width:420px;
  padding:18px;
  border:1px dashed var(--edge);
  border-radius:16px;
  background:#00000028;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:12px;
}

/* QR kanvas boyutları: laptop için rahat sığsın */
.qrbox canvas{
  display:block;
  width:100%;
  max-width:300px;   /* laptopta yan yana sığar */
  height:auto;
  aspect-ratio:1/1;
  background:#fff;
  border-radius:12px;
  box-shadow:0 6px 20px #00000033;
}

/* Etiketleri daha okunaklı yap */
.qrbox .hint:first-of-type{
  font-size:16px;
  font-weight:900;
  color:var(--ink);
  letter-spacing:.2px;
  text-align:center;
}
.qrbox .hint + .hint{
  /* "Geçerlilik" satırı */
  font-size:12px;
  color:var(--muted);
  text-align:center;
}

</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="row">
      <div id="roomName" class="pill">Oda: —</div>
      <div id="nowInfo" class="pill">—</div>
    </div>
    <div id="stateChip" class="status">Durum: —</div>
  </div>

  <div class="grid">
    <!-- SOL: 4'lü QR -->
    <section class="card">
      <h2>Bu saatin QR’ları</h2>
      <div class="qr4">
        <div class="qrbox">
          <canvas id="qr-enter" width="260" height="260"></canvas>
          <div class="hint">Giriş (act=enter)</div>
          <div id="until-enter" class="hint"></div>
        </div>
        <div class="qrbox">
          <canvas id="qr-exit" width="260" height="260"></canvas>
          <div class="hint">Çıkış (act=exit)</div>
          <div id="until-exit" class="hint"></div>
        </div>
        <div class="qrbox">
          <canvas id="qr-break_start" width="260" height="260"></canvas>
          <div class="hint">Mola Başlat (act=break_start)</div>
          <div id="until-break_start" class="hint"></div>
        </div>
        <div class="qrbox">
          <canvas id="qr-break_end" width="260" height="260"></canvas>
          <div class="hint">Mola Bitir (act=break_end)</div>
          <div id="until-break_end" class="hint"></div>
        </div>
      </div>
      <div class="hint" id="qrLinks" style="margin-top:8px;word-break:break-all"></div>
    </section>

    <!-- SAĞ: anlık bilgi -->
    <section class="card">
      <h2>Anlık Durum</h2>
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="muted">İçeride tahmini kişi</div>
          <div id="occupancy" class="big">—</div>
        </div>
        <div>
          <div class="muted">Rezervasyon</div>
          <div id="resLabel" style="font-weight:900">—</div>
          <div id="resSub" class="hint"></div>
        </div>
      </div>
      <div style="margin-top:12px">
        <div class="muted">Sıradaki rezervasyon</div>
        <ul id="nextList" class="list"><li class="muted">—</li></ul>
      </div>
    </section>
  </div>
</div>

<!-- QR lib: yerel varsa onu, yoksa CDN -->
<script src="assets/qrcode.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
/* ====== Firebase ====== */
var firebaseConfig = {
  apiKey:"AIzaSyDJtcrJ6Eh4BfZnn0M-4z9QYi_2AS-ikHw",
  authDomain:"ieee-oda.firebaseapp.com",
  databaseURL:"https://ieee-oda-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"ieee-oda",
  storageBucket:"ieee-oda.firebasestorage.app",
  messagingSenderId:"788998880363",
  appId:"1:788998880363:web:5eacc71c326cffe7b3452e"
};
firebase.initializeApp(firebaseConfig);
var auth=firebase.auth(), db=firebase.database();

/* ====== helpers ====== */
function $(id){ return document.getElementById(id); }
function urlParam(n){ try{ return new URL(location.href).searchParams.get(n); }catch(_){ return null; } }
var ROOM = urlParam('room') || 'LAB-101';
$('roomName').textContent = 'Oda: ' + ROOM;

function safeText(id, t){ var el=$(id); if(el) el.textContent = t; }
function fmt(ts){ return new Date(ts).toLocaleString(); }
function fmtTime(ts){ var d=new Date(ts); return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); }
function fmtRange(s,e){
  var ds=new Date(s), de=new Date(e);
  var sameDay = ds.toDateString()===de.toDateString();
  var day = ds.toLocaleDateString();
  return sameDay ? (day+' '+fmtTime(s)+'–'+fmtTime(e)) : (fmt(s)+' – '+fmt(e));
}
function fmtTR(dt){
  return dt.toLocaleString('tr-TR', {
    timeZone: 'Europe/Istanbul',
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit'
  }).replace(',', '');
}
function tickClock(){ safeText('nowInfo', fmtTR(new Date())); }

/* ====== QR lib (gerekirse CDN) ====== */
function ensureQRCodeLib(){
  if (window.QRCode) return Promise.resolve();
  return new Promise(function(resolve,reject){
    var s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js';
    s.onload=resolve;
    s.onerror=function(){ reject(new Error('QRCode lib yüklenemedi')); };
    document.head.appendChild(s);
  });
}

/* ====== iki API'ye göre canvas'a çiz ====== */
function drawQRToCanvasId(canvasId, link){
  var cvs = $(canvasId);
  var ctx = cvs.getContext('2d');

  // Ölçüyü ebeveyn kutudan al ki gap/padding’e saygı duysun
  var parent = cvs.parentElement;
  var parentW = parent ? parent.clientWidth : 320;

  // 220–320 aralığında sıkıştır
  var w = Math.max(220, Math.min(320, parentW - 20));
  cvs.width = w; 
  cvs.height = w;
  ctx.clearRect(0,0,w,w);

  // npm "qrcode"
  if (window.QRCode && typeof QRCode.toCanvas === 'function') {
    return new Promise(function(resolve, reject){
      QRCode.toCanvas(cvs, link, { width: w, margin: 1 }, function(err){
        return err ? reject(err) : resolve();
      });
    });
  }

  // davidshimjs/qrcodejs (fallback)
  if (window.QRCode) {
    return new Promise(function(resolve){
      var tmp = document.createElement('div');
      tmp.style.position='absolute'; tmp.style.left='-9999px';
      document.body.appendChild(tmp);
      var q = new QRCode(tmp, { text: link, width: w, height: w });
      var cleanup = function(){ q.clear && q.clear(); tmp.remove(); };
      var tryDraw = function(){
        var cnv = tmp.querySelector('canvas');
        var img = tmp.querySelector('img');
        if (cnv){ ctx.drawImage(cnv,0,0,w,w); cleanup(); resolve(); return; }
        if (img){
          if (img.complete){ ctx.drawImage(img,0,0,w,w); cleanup(); resolve(); }
          else img.onload = function(){ ctx.drawImage(img,0,0,w,w); cleanup(); resolve(); };
          return;
        }
        setTimeout(tryDraw, 30);
      };
      tryDraw();
    });
  }

  return Promise.reject(new Error('QR kütüphanesi bulunamadı'));
}

/* ====== saatlik key ====== */
function hourTokenUTC(d){
  d = d || new Date();
  var y=d.getUTCFullYear();
  var m=('0'+(d.getUTCMonth()+1)).slice(-2);
  var day=('0'+d.getUTCDate()).slice(-2);
  var h=('0'+d.getUTCHours()).slice(-2);
  return ''+y+m+day+h;
}
function sha256Hex(s){
  var enc = new TextEncoder().encode(s);
  return crypto.subtle.digest('SHA-256', enc).then(function(buf){
    var arr = Array.from(new Uint8Array(buf));
    return arr.map(function(b){ return b.toString(16).padStart(2,'0'); }).join('');
  });
}
function takeKey6FromHex(hex){
  var map='0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  var out=''; 
  for(var i=0;i<hex.length && out.length<6;i++){
    var v=parseInt(hex[i],16);
    out+=map[v % map.length];
  }
  return out.toUpperCase();
}
function computeHourlyKey(seed,date){
  return sha256Hex(seed + hourTokenUTC(date||new Date())).then(takeKey6FromHex);
}

/* seed oku (yanlış yazıma da bak) */
function getSeed(room){
  return db.ref('roomKeySeed/'+room).get().then(function(s){
    if(s.exists()) return String(s.val());
    return db.ref('roomkeySeed/'+room).get().then(function(s2){
      return s2.exists()? String(s2.val()): '';
    });
  });
}

/* ====== 4 adet QR üret ====== */
var ACTIONS = [
  {key:'enter',       label:'Giriş'},
  {key:'exit',        label:'Çıkış'},
  {key:'break_start', label:'Mola Başlat'},
  {key:'break_end',   label:'Mola Bitir'}
];
var lastDrawnHour = '';

function makeQR(){
  return ensureQRCodeLib().then(function(){
    return getSeed(ROOM);
  }).then(function(seed){
    if(!seed){ safeText('qrLinks','Seed yok'); return; }

    var now=new Date();
    var hourTag=hourTokenUTC(now);

    // aynı saatteyse sadece geçerlilik bilgisini yenile
    if (lastDrawnHour===hourTag){
      var nh=new Date();
      nh.setUTCMinutes(0,0,0);
      nh.setUTCHours(nh.getUTCHours()+1);
      for (var i=0;i<ACTIONS.length;i++){
        safeText('until-'+ACTIONS[i].key, 'Geçerlilik (TR): ' + fmtTR(nh));
      }
      return;
    }

    return computeHourlyKey(seed, now).then(function(key){
      var base = location.origin + '/panel?auto=1&room=' + encodeURIComponent(ROOM) + '&key=' + encodeURIComponent(key);
      var linksTxt = [];
      var nh=new Date(); nh.setUTCMinutes(0,0,0); nh.setUTCHours(nh.getUTCHours()+1);

      // her aksiyon için çiz
      var chain = Promise.resolve();
      ACTIONS.forEach(function(a){
        var link = base + '&act=' + encodeURIComponent(a.key);
        linksTxt.push(a.label + ': ' + link);
        chain = chain.then(function(){ return drawQRToCanvasId('qr-'+a.key, link); })
                     .then(function(){ safeText('until-'+a.key, 'Geçerlilik (TR): ' + fmtTR(nh)); });
      });

      return chain.then(function(){
        safeText('qrLinks', linksTxt.join('  |  '));
        lastDrawnHour = hourTag;
      });
    });
  }).catch(function(e){
    safeText('qrLinks', 'QR üretilemedi: ' + (e && e.message ? e.message : e));
  });
}

/* ====== rezervasyon ====== */
function loadReservations(){
  try{
    var now = Date.now();
    var ref = db.ref('roomReservations/'+ROOM).orderByChild('startAt').startAt(now-48*3600e3).endAt(now+72*3600e3);
    ref.get().then(function(s){
      var rows = Object.values(s.val()||{}).sort(function(a,b){ return (a.startAt||0)-(b.startAt||0); });

      var active = rows.find(function(r){
        return (r.startAt||0) <= now && now <= (r.endAt||0) && (r.status||'pending') === 'approved';
      });

      if (active) {
        safeText('resLabel','REZERVE');
        safeText('resSub', (active.title||'') + ' — ' + fmtRange(active.startAt, active.endAt));
        var chip=$('stateChip'); if(chip){ chip.textContent='Durum: Rezerveli'; chip.className='status reserved'; }
      } else {
        safeText('resLabel','Müsait');
        safeText('resSub','');
        var chip2=$('stateChip'); if(chip2){ chip2.textContent='Durum: Boş'; chip2.className='status ok'; }
      }

      var upcoming = rows.filter(function(r){ return (r.startAt||0) > now && (r.status||'pending') === 'approved'; }).slice(0,3);
      var ul=$('nextList'); ul.innerHTML='';
      if (!upcoming.length){
        ul.innerHTML = '<li class="muted">Yakın zamanda rezervasyon yok</li>';
      }else{
        upcoming.forEach(function(r){
          var li=document.createElement('li');
          li.textContent = fmtRange(r.startAt,r.endAt) + ' • ' + (r.title||r.userName||r.userId||'');
          ul.appendChild(li);
        });
      }
    });
  }catch(_){}
}

/* ====== doluluk ====== */
function loadOccupancy(){
  try{
    var since=Date.now()-24*3600e3;
    db.ref('attendanceByRoom/'+ROOM).orderByChild('createdAt').startAt(since).get().then(function(s){
      var rows = Object.values(s.val()||{}).sort(function(a,b){ return (a.createdAt||0)-(b.createdAt||0); });
      var state = {};
      rows.forEach(function(r){
        if (r.action==='enter') state[r.userId]=true;
        if (r.action==='exit')  state[r.userId]=false;
      });
      var inside = Object.keys(state).filter(function(k){ return !!state[k]; }).length;
      safeText('occupancy', String(inside));
    });
  }catch(_){}
}

/* ====== auth + loop ====== */
auth.onAuthStateChanged(function(u){
  if(!u){
    location.replace('login?next='+encodeURIComponent(location.href));
    return;
  }
  db.ref('admins/'+u.uid).get().then(function(s){
    var isAdmin = s.exists() && s.val()===true;
    if(!isAdmin){ alert('Admin yetkisi yok.'); return; }

    makeQR();
    loadReservations();
    loadOccupancy();
    tickClock();

    setInterval(tickClock, 1000);
    setInterval(makeQR, 60*1000);
    setInterval(loadReservations, 30*1000);
    setInterval(loadOccupancy,   30*1000);
  });
});

// görünür olunca/resize olunca tazele
document.addEventListener('visibilitychange', function(){ if(!document.hidden){ makeQR(); loadReservations(); loadOccupancy(); tickClock(); }});
window.addEventListener('resize', function(){ lastDrawnHour=''; makeQR(); });
</script>
</body>
</html>
