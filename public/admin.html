<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<link rel="icon" href="assets/techops.ico" type="image/x-icon" />
<title>TechOps â€” Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="manifest" href="/manifest.json">
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js');
    });
  }
</script>



<style>
  :root{
    --bg:#0b1118; --card:#0f1a27; --ink:#e8eef6; --muted:#9bb0c8; --edge:#1f2b3b;
    --pri:#2aa3ff; --pri-2:#58bfff; --ok:#62d29a; --err:#ff8a8a; --warn:#ffd27a;
    --radius:16px; --radius-sm:12px; --ring:0 0 0 3px rgba(42,163,255,.22);
    --shadow: 0 20px 50px rgba(0,0,0,.35);
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f6f9ff; --card:#ffffff; --ink:#0e2136; --muted:#6d7a90; --edge:#e6ebf4;
      --pri:#0a7cc1; --pri-2:#0b5fa3; --ok:#1a7f37; --err:#b00020; --warn:#8a5a00;
      --shadow: 0 16px 40px rgba(0,43,92,.08);
    }
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    background:
      radial-gradient(1200px 800px at 70% -10%, rgba(90,170,255,.12), transparent 60%),
      radial-gradient(900px 600px at -10% 110%, rgba(100,255,210,.10), transparent 60%),
      var(--bg);
    color:var(--ink);
  }

  /* topbar */
  .topbar{
    position:sticky; top:0; z-index:40; display:flex; align-items:center; gap:12px; padding:12px 16px;
    backdrop-filter:saturate(140%) blur(10px);
    background: color-mix(in oklab, var(--card) 88%, transparent);
    border-bottom:1px solid var(--edge);
  }
  .brand{display:flex;align-items:center;gap:10px;font-weight:900}
  .badge{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--pri),var(--pri-2));box-shadow:0 8px 20px rgba(42,163,255,.35)}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid var(--edge);background:rgba(255,255,255,.04)}
  .mini{display:inline-flex;align-items:center;gap:8px;padding:6px 8px;border:1px solid var(--edge);border-radius:999px;background:rgba(255,255,255,.04);font-size:12px}
  .bar{width:80px;height:6px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden}
  .bar>i{display:block;height:100%;width:30%;background:linear-gradient(90deg,var(--pri),var(--pri-2))}
  .right{margin-left:auto;display:flex;gap:10px;align-items:center}

  /* shell */
  .wrap{max-width:1400px;margin:18px auto;padding:0 12px 32px}

  /* toolbar (filtre/CSV/QR) */
  .card{
    background: linear-gradient(180deg, color-mix(in oklab, var(--card) 96%, transparent), var(--card));
    border:1px solid var(--edge); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px;
  }
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--err)} .warn{color:var(--warn)}
  input,select,button,textarea{
    padding:10px 12px; border-radius:12px; border:1px solid var(--edge);
    background:rgba(255,255,255,.04); color:var(--ink); font-size:14px;
    transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
  }
  input:focus,select:focus,textarea:focus{outline:none;border-color:color-mix(in oklab,var(--pri) 65%, var(--edge)); box-shadow:var(--ring)}
  button{background:linear-gradient(90deg,var(--pri),var(--pri-2)); color:#031424; border:none; cursor:pointer; font-weight:900; transition:transform .08s ease}
  button:hover{ transform: translateY(-1px) }
  button:active{ transform: translateY(0) scale(.99) }
  button.ghost{ background:rgba(255,255,255,.04); color:var(--ink); border:1px solid var(--edge) }
  button.red{ background:#cf2d39; color:#fff }
  button:disabled{opacity:.6; cursor:not-allowed}

  /* tiles */
  .tiles{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:14px}
  @media (max-width:1100px){ .tiles{grid-template-columns:repeat(3,minmax(0,1fr));} }
  @media (max-width:820px){ .tiles{grid-template-columns:repeat(2,minmax(0,1fr));} }
  @media (max-width:520px){ .tiles{grid-template-columns:1fr;} }
  .tile{background:var(--card); border:1px solid var(--edge); border-radius:14px; padding:14px; display:flex; flex-direction:column; gap:8px; box-shadow:0 10px 24px #001a3b16}
  .tile h3{margin:0;font-size:16px}
  .tile p{margin:0;font-size:12px;color:var(--muted)}
  .btn{padding:12px 12px;border-radius:12px;border:none;font-weight:800;cursor:pointer;background:var(--pri);color:#031424;display:inline-flex;align-items:center;justify-content:center;gap:8px}
  .btn.light{background:rgba(255,255,255,.06);color:var(--ink);border:1px solid var(--edge)}

  /* tables */
  .table-wrap{overflow:auto;border:1px solid var(--edge);border-radius:12px}
  table{width:100%;border-collapse:separate;border-spacing:0;min-width:760px}
  th,td{padding:12px;border-bottom:1px solid var(--edge);font-size:14px;text-align:left;vertical-align:top}
  th{position:sticky;top:0;background:color-mix(in oklab,var(--card) 98%, transparent);z-index:1;font-weight:900}
  tbody tr:hover td{background:rgba(42,163,255,.06)}
  .empty{padding:18px;text-align:center;color:var(--muted)}

  /* chips */
  .chip{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border:1px solid var(--edge); border-radius:999px; font-size:12px; font-weight:800}
  .chip.pending{background:rgba(255,210,122,.12); color:var(--warn); border-color: rgba(255,210,122,.35)}
  .chip.approved{background:rgba(98,210,154,.12); color:var(--ok); border-color: rgba(98,210,154,.35)}
  .chip.declined{background:rgba(255,138,138,.12); color:var(--err); border-color: rgba(255,138,138,.35)}

  /* dialogs */
  dialog{border:none;border-radius:16px;padding:0;width:min(95vw,1200px);background:var(--card);border:1px solid var(--edge); box-shadow:var(--shadow)}
  .dlg-head{padding:14px 16px;border-bottom:1px solid var(--edge);font-weight:900;display:flex;align-items:center;justify-content:space-between}
  .dlg-body{padding:16px}
  .dlg-foot{padding:12px 16px;border-top:1px solid var(--edge);display:flex;gap:8px;justify-content:flex-end}

  /* QR canvases */
  .qr{border:1px solid var(--edge);border-radius:12px;background:#fff}

  /* toast */
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 8px 24px #0006;font-weight:800;opacity:0;pointer-events:none;transition:.25s}
  .toast.show{opacity:1;pointer-events:auto}
  /* === DIALOG Ä°Ã‡Ä° OKUNAKLILIK FIX (dark mode aÄŸÄ±rlÄ±klÄ±) === */
dialog .dlg-body,
dialog table,
dialog th,
dialog td { color: var(--ink) !important; }

@media (prefers-color-scheme: dark){
  /* Dialog zemini biraz aÃ§ */
  dialog{
    background:#111a27 !important;
    border-color:#2a3a52 !important;
  }
  /* Tablo baÅŸlÄ±ÄŸÄ±/Ã§izgiler */
  dialog .table-wrap{ background: transparent; }
  dialog th{
    background:#162338 !important;
    color:#e8eef6 !important;
    border-bottom:1px solid #2a3a52 !important;
  }
  dialog td{
    color:#dfe7f4 !important;
    border-bottom:1px solid #223449 !important;
  }
  /* SatÄ±r arasÄ± ayrÄ±m + hover */
  dialog tbody tr{ background: rgba(255,255,255,.01); }
  dialog tbody tr:hover td{ background: rgba(74,163,255,.08) !important; }

  /* Durum rozetleri (chip) daha belirgin */
  dialog .chip{ border-color:#2a3a52 !important; }
  dialog .chip.pending{
    background:#2e240f !important; color:#ffd27a !important; border-color:#5a471e !important;
  }
  dialog .chip.approved{
    background:#103022 !important; color:#9ff0c0 !important; border-color:#1e3a2f !important;
  }
  dialog .chip.declined{
    background:#3a1414 !important; color:#ff9b9b !important; border-color:#5a2020 !important;
  }

  /* Form elemanlarÄ± (select, ghost butonlar) */
  dialog select,
  dialog input,
  dialog textarea{
    background:#0e1622 !important; color:#e8eef6 !important; border:1px solid #2d3e55 !important;
  }
  dialog select:focus,
  dialog input:focus,
  dialog textarea:focus{ box-shadow:0 0 0 3px rgba(74,163,255,.22) !important; }

  dialog button.ghost{
    background:#17253a !important; color:#e8eef6 !important; border:1px solid #2d3e55 !important;
  }
}

/* MasaÃ¼stÃ¼nde de metni netleÅŸtir (light mode iÃ§in kÃ¼Ã§Ã¼k dokunuÅŸ) */
dialog th{ font-weight:800; }
dialog td{ color: var(--ink); }


</style>


</head>
<body>

<!-- ===== Topbar ===== -->
<header class="topbar" aria-label="Ãœst menÃ¼">
  <div class="brand"><span class="badge"></span><span>TechOps â€¢ Admin Panel</span></div>
  <span id="mePill" class="pill">â€”</span>
  <div class="right">
  


    <span class="mini" title="YaklaÅŸÄ±k doluluk (24s)">
      <span id="occupy">Doluluk: â€”</span>
      <span class="bar"><i style="width:40%"></i></span>
    </span>
    <span id="staleBadge" class="pill" style="display:none">âš ï¸ 0 aÃ§Ä±k</span>
    <span id="cash" class="pill">Kasa: â€”</span>
    <button id="logout" class="ghost">Ã‡Ä±kÄ±ÅŸ</button>
  </div>
</header>

<div class="wrap">

  <!-- ===== Ãœst AraÃ§ Ã‡ubuÄŸu (filtreler + csv + QR kÄ±sayolu) ===== -->
  <section class="card" style="margin-bottom:14px">
    <div class="row" style="align-items:flex-end">
      <div class="row">
        <label>Oda</label>
        <select id="roomSelect"></select>
        <button id="refresh" class="ghost">Yenile</button>
        <label class="row" style="gap:6px"><input type="checkbox" id="live"> CanlÄ± izle</label>
      </div>
      <div class="row">
        <label>Tarih</label>
        <select id="datePreset">
          <option value="today">BugÃ¼n</option>
          <option value="yesterday">DÃ¼n</option>
          <option value="7d" selected>Son 7 gÃ¼n</option>
          <option value="30d">Son 30 gÃ¼n</option>
          <option value="custom">Ã–zel</option>
        </select>
        <input type="datetime-local" id="startAt" />
        <input type="datetime-local" id="endAt" />
      </div>
      <div class="row" style="margin-left:auto">
        <button id="csvAttend" class="ghost">Attendance CSV</button>
        <button id="csvFeedback" class="ghost">Feedback CSV</button>
        <button id="csvInv" class="ghost">Inventory CSV</button>
        <button id="csvRes" class="ghost">Reservations CSV</button>
        <button id="openQRmgr" class="ghost">QR / Oda AnahtarÄ±</button>
        <span id="status" class="muted"></span>
      </div>
    </div>
  </section>

  <!-- ===== Ana MenÃ¼ (YAN MENÃœ YOK) â€” Kartlar ===== -->
  <section class="tiles">
    <div class="tile"><h3>GiriÅŸ/Ã‡Ä±kÄ±ÅŸ KayÄ±tlarÄ±</h3><p>SeÃ§ili aralÄ±k iÃ§in tÃ¼m hareketler</p><button class="btn" data-open="dlg-att">ğŸ“‹ AÃ§</button></div>
    <div class="tile"><h3>Ã‡Ä±kÄ±ÅŸ YorumlarÄ±</h3><p>Puanlama / fotoÄŸraf / etiket</p><button class="btn light" data-open="dlg-fb">ğŸ’¬ AÃ§</button></div>
    <div class="tile"><h3>Eksik / Ekipman</h3><p>Ä°stekler ve faturaya dÃ¶nÃ¼ÅŸtÃ¼rme</p><button class="btn light" data-open="dlg-inv">ğŸ“¦ AÃ§</button></div>
    <div class="tile"><h3>Rezervasyonlar</h3><p>Onayla / reddet / sil</p><button class="btn light" data-open="dlg-res">ğŸ“… AÃ§</button></div>
    <div class="tile"><h3>Admin YÃ¶netimi</h3><p>E-posta ile admin ver/kaldÄ±r</p><button class="btn light" data-open="dlg-admin">ğŸ›¡ï¸ AÃ§</button></div>
    <div class="tile"><h3>Finans</h3><p>Faturalar & Aidat bildirimleri</p><button class="btn light" data-open="dlg-fin">ğŸ’° AÃ§</button></div>
    <div class="tile">
      <h3>Ä°Ã§eride Unutulanlar</h3>
      <p>24 saati geÃ§en aÃ§Ä±k oturumlar</p>
      <button class="btn light" data-open="dlg-stale">â° AÃ§</button>
    </div>

  </section>

</div>

<!-- ===== DIALOGS ===== -->

<!-- Attendance -->
<dialog id="dlg-att">
  <div class="dlg-head"><span>GiriÅŸ/Ã‡Ä±kÄ±ÅŸ</span><button class="ghost" data-close>âœ•</button></div>
  <div class="dlg-body">
    <div class="table-wrap">
      <table>
        <thead><tr><th>Zaman</th><th>KullanÄ±cÄ±</th><th>Aksiyon</th><th>Oda</th><th>Kaynak</th></tr></thead>
        <tbody id="attBody"><tr><td colspan="5" class="empty">Veri yok</td></tr></tbody>
      </table>
    </div>
  </div>
  <div class="dlg-foot"><button class="ghost" data-close>Kapat</button></div>
</dialog>

<!-- Feedback -->
<dialog id="dlg-fb">
  <div class="dlg-head"><span>Ã‡Ä±kÄ±ÅŸ YorumlarÄ±</span><button class="ghost" data-close>âœ•</button></div>
  <div class="dlg-body">
    <div class="row" style="margin-bottom:8px">
      <input id="fbQuery" placeholder="Ara (kullanÄ±cÄ± / yorum / etiket)" style="min-width:260px">
      <select id="fbState">
        <option value="all">TÃ¼mÃ¼</option>
        <option value="open">Sadece aÃ§Ä±k</option>
        <option value="resolved">Sadece Ã§Ã¶zÃ¼len</option>
      </select>
      <button class="ghost" id="fbClear">Filtreyi Temizle</button>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Zaman</th><th>KullanÄ±cÄ±</th><th>Durum</th><th>Puan</th><th>Yorum</th><th>Etiketler</th><th>YÃ¶net</th></tr></thead>
        <tbody id="fbBody"><tr><td colspan="7" class="empty">Veri yok</td></tr></tbody>
      </table>
    </div>
  </div>
  <div class="dlg-foot"><button class="ghost" data-close>Kapat</button></div>
</dialog>

<!-- Inventory -->
<dialog id="dlg-inv">
  <div class="dlg-head"><span>Eksik / Ekipman</span><button class="ghost" data-close>âœ•</button></div>
  <div class="dlg-body">
    <div class="table-wrap">
      <table>
        <thead><tr><th>Zaman</th><th>KullanÄ±cÄ±</th><th>Adet</th><th>ÃœrÃ¼n</th><th>Not</th><th>Durum</th><th>Ä°ÅŸlem</th></tr></thead>
        <tbody id="invBody"><tr><td colspan="7" class="empty">Veri yok</td></tr></tbody>
      </table>
    </div>
  </div>
  <div class="dlg-foot"><button class="ghost" data-close>Kapat</button></div>
</dialog>

<!-- Reservations -->
<dialog id="dlg-res">
  <div class="dlg-head"><span>Rezervasyonlar</span><button class="ghost" data-close>âœ•</button></div>
  <div class="dlg-body">
    <div class="table-wrap">
      <table>
        <thead><tr><th>BaÅŸlangÄ±Ã§</th><th>BitiÅŸ</th><th>KullanÄ±cÄ±</th><th>BaÅŸlÄ±k</th><th>Not</th><th>Durum</th><th>Ä°ÅŸlem</th></tr></thead>
        <tbody id="resBody"><tr><td colspan="7" class="empty">Veri yok</td></tr></tbody>
      </table>
    </div>
  </div>
  <div class="dlg-foot"><button class="ghost" data-close>Kapat</button></div>
</dialog>

<!-- Admin -->
<dialog id="dlg-admin">
  <div class="dlg-head"><span>Admin YÃ¶netimi</span><button class="ghost" data-close>âœ•</button></div>
  <div class="dlg-body">
    <div class="row">
      <input id="emailFind" placeholder="KullanÄ±cÄ± e-postasÄ±" style="min-width:260px">
      <button id="findUser">Bul</button>
      <span id="findRes" class="muted"></span>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="makeAdmin">Admin Yap</button>
      <button id="removeAdmin" class="ghost">AdminliÄŸi KaldÄ±r</button>
    </div>
    <div class="muted" style="margin-top:8px">
      Not: KullanÄ±cÄ±lar <code>/users</code> altÄ±nda <code>email</code> ile aranÄ±r. Adminlik: <code>/admins/{uid}: true</code>.
    </div>
  </div>
  <div class="dlg-foot"><button class="ghost" data-close>Kapat</button></div>
</dialog>

<!-- Finance -->
<dialog id="dlg-fin">
  <div class="dlg-head"><span>Finans</span><button class="ghost" data-close>âœ•</button></div>
  <div class="dlg-body">

    <div class="row" style="gap:6px;margin:6px 0">
      <button class="ghost" id="fillThisMonth">Bu ayÄ± doldur</button>
      <button class="ghost" id="fillDefaultAmount">â‚º100 hÄ±zlÄ± doldur</button>
    </div>



    <div class="row" style="gap:12px; align-items:flex-end; margin-bottom:10px">
      <div>
        <h4 style="margin:0 0 6px">AylÄ±k Aidat OluÅŸtur</h4>
        <div class="row" style="gap:8px">
          <input id="finMonth" placeholder="YYYY-MM (Ã¶rn. 2025-02)" style="max-width:160px">
          <input id="finDueAmount" type="number" min="0" step="0.01" placeholder="Tutar (â‚º)" style="max-width:140px">
          <input id="finEmails" placeholder="E-posta(lar), virgÃ¼lle" style="min-width:280px" />
          <button id="makeDues">Aidat Kes</button>
        </div>
        <div class="muted" style="font-size:12px; margin-top:6px">
          E-postalar <code>/users</code> ile eÅŸleÅŸtirilir; her kiÅŸi iÃ§in â€œAidat {YYYY-MM}â€ faturasÄ± aÃ§Ä±lÄ±r.
        </div>
        <div class="row" style="gap:8px;margin:8px 0">
        <input id="remMonth" placeholder="YYYY-MM" style="max-width:140px">
        <button id="remAll" class="ghost">Bu ay tÃ¼m Ã¶denmemiÅŸleri hatÄ±rlat</button>
      </div>
        <h4 style="margin:10px 0 6px">Aidat Bildirimleri</h4>
        <div class="row" style="gap:8px; margin-bottom:6px">
          <button id="reloadDues" class="ghost">Yenile</button>
          <span class="muted">KullanÄ±cÄ±larÄ±n â€œAidat Bildirâ€ talepleri. Onay â†’ kasa artar.</span>
        </div>

        <div class="row" style="gap:8px;margin:8px 0">
          <input id="reqMonth" placeholder="YYYY-MM" style="max-width:140px">
          <input id="reqAmount" type="number" min="0" step="0.01" placeholder="â‚º" style="max-width:120px">
          <input id="reqEmails" placeholder="E-posta(lar), virgÃ¼lle" style="min-width:280px">
          <button id="askDues" class="ghost">Aidat Ä°ste</button>
        </div>

        <div class="table-wrap" style="margin-bottom:14px">
          <table>
            <thead><tr><th>Zaman</th><th>KullanÄ±cÄ±</th><th>DÃ¶nem</th><th>Tutar</th><th>Durum</th><th>Ä°ÅŸlem</th></tr></thead>
            <tbody id="duesTable"><tr><td colspan="6" class="empty">Veri yok</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- Ã–deme AyarlarÄ± -->
    <div class="card" style="margin:12px 0">
      <h4 style="margin:0 0 8px">Ã–deme AyarlarÄ± (IBAN / BaÄŸlantÄ±)</h4>
      <div class="row" style="gap:8px; align-items:flex-end">
        <input id="payBankName" placeholder="Banka & Hesap adÄ± (Ã¶rn. TechOps BankasÄ± â€” Hesap: TechOps A.Å.)" style="min-width:260px">
        <input id="payIbanInp" placeholder="IBAN (Ã¶rn. TR33 0006 1005 1978 6457 8413 26)" style="min-width:260px">
        <input id="payUrlInp" placeholder="Ã–deme baÄŸlantÄ±sÄ± (opsiyonel)" style="min-width:320px">
        <button id="savePayInfo">Kaydet</button>
        <span id="payInfoMsg" class="muted"></span>
      </div>
    </div>

    <hr style="border:none;border-top:1px solid var(--edge); margin:12px 0">

    <h4 style="margin:0 0 6px">En Son Faturalar</h4>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Zaman</th><th>KullanÄ±cÄ±</th><th>BaÅŸlÄ±k</th><th>Tutar</th><th>Durum</th><th>Ä°ÅŸlem</th></tr></thead>
        <tbody id="invTable"><tr><td colspan="6" class="empty">Veri yok</td></tr></tbody>
      </table>
    </div>
  </div>
  <div class="dlg-foot"><button class="ghost" data-close>Kapat</button></div>
</dialog>

<!-- QR / Room Key Manager -->
<dialog id="dlg-qr">
  <div class="dlg-head"><span>QR & Oda AnahtarÄ±</span><button class="ghost" data-close>âœ•</button></div>
  <div class="dlg-body">
    <div class="row" style="align-items:flex-end;gap:12px">
      <input id="newRoomId" placeholder="Oda kodu (Ã¶rn. LAB-101)" />
      <input id="newRoomKey" placeholder="Anahtar (Ã¶rn. ABCD12)" />
      <button id="addRoom">Ekle/GÃ¼ncelle</button>
      <button id="delRoom" class="red">OdayÄ± Sil</button>
      <button id="rotateKey" class="ghost">SeÃ§ili OdanÄ±n AnahtarÄ±nÄ± Yenile</button>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="gateBase" style="flex:1" placeholder="QR gate tabanÄ± (Ã¶rn. https://site.com/gate.html)">
    </div>
    <div class="row" style="margin-top:12px;gap:16px;align-items:center">
      <canvas id="qrCanvas" class="qr" width="160" height="160" aria-label="KÃ¼Ã§Ã¼k QR"></canvas>
      <div style="max-width:640px">
        <div class="muted" id="qrText" style="overflow-wrap:anywhere"></div>
        <div class="row" style="margin-top:8px">
          <button id="makeQR">QR OluÅŸtur</button>
          <button id="downloadQR" class="ghost">PNG indir</button>
          <button id="openQR" class="ghost">BÃ¼yÃ¼t</button>
        </div>
      </div>
    </div>
  </div>
  <div class="dlg-foot"><button class="ghost" data-close>Kapat</button></div>
</dialog>

<!-- QR Big -->
<dialog id="qrDlg">
  <div class="dlg-head">QR â€” SeÃ§ili Oda</div>
  <div class="dlg-body" style="display:flex;gap:12px;align-items:center">
    <canvas id="qrBig" width="320" height="320" class="qr"></canvas>
    <div style="word-break:break-all"><div class="muted">BaÄŸlantÄ±:</div><div id="qrLinkTxt"></div></div>
  </div>
  <div class="dlg-foot">
    <button class="ghost" id="qrClose">Kapat</button>
    <button id="qrDownload">PNG indir</button>
  </div>
</dialog>


<!-- Payment dialog -->
<dialog id="payDlg">
  <div class="dlg-head"><span>Fatura Ã–deme</span><button class="ghost" data-close>âœ•</button></div>
  <div class="dlg-body" style="display:flex;gap:12px;flex-direction:column">
    <div style="display:flex;gap:12px;align-items:flex-start">
      <div style="min-width:260px">
        <div class="muted">AlÄ±cÄ± / Banka</div>
        <div id="payBank" style="font-weight:800;margin-bottom:6px">â€”</div>

        <div class="muted">IBAN</div>
        <div style="display:flex;gap:8px;align-items:center">
          <div id="payIban" style="font-family:monospace;font-weight:800">â€”</div>
          <button id="copyIban" class="ghost" style="margin-left:auto">Kopyala</button>
        </div>

        <div class="muted" style="margin-top:8px">AÃ§Ä±klama</div>
        <div id="payDesc" style="font-size:13px;word-break:break-all">â€”</div>
      </div>

      <div style="flex:1">
        <div class="muted">Tutar</div>
        <div id="payAmount" style="font-size:28px;font-weight:900;margin-bottom:8px">â€”</div>

        <div class="muted">Ã–deme baÄŸlantÄ±sÄ±</div>
        <div id="payUrlWrap" style="margin-bottom:8px">
          <a id="payUrl" target="_blank" rel="noopener noreferrer"></a>
        </div>

        <div style="display:flex;gap:8px">
          <button id="gotoBank" class="btn light">Bankaya Git</button>
          <button id="markPaidNow" class="btn">Ã–dendi Olarak Ä°ÅŸaretle</button>
        </div>

        <div class="muted" style="margin-top:10px;font-size:13px">
          Not: EÄŸer doÄŸrudan banka linki eklenmiÅŸse "Bankaya Git" onu aÃ§ar. Aksi takdirde IBAN'Ä± kopyalayÄ±p kendi internet bankacÄ±lÄ±ÄŸÄ±nÄ±zdan gÃ¶nderim yapabilirsiniz.
        </div>
      </div>
    </div>
  </div>
  <div class="dlg-foot"><button class="ghost" data-close>Kapat</button></div>
</dialog>

<!-- Photo preview for feedback (admin) -->
<dialog id="photoDlg">
  <div class="dlg-head">FotoÄŸraf Ã–nizleme</div>
  <div class="dlg-body">
    <img id="photoFull" alt="FotoÄŸraf" style="max-width:100%;border-radius:12px;border:1px solid var(--edge)">
  </div>
  <div class="dlg-foot"><button id="photoClose" class="ghost">Kapat</button></div>
</dialog>

<!-- Stale (24h+) inside list -->
<dialog id="dlg-stale">
  <div class="dlg-head">
    <span>Ä°Ã§eride Unutulanlar (24s+)</span>
    <button class="ghost" data-close>âœ•</button>
  </div>
  <div class="dlg-body">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>KullanÄ±cÄ±</th>
            <th>Odaya GiriÅŸ</th>
            <th>GeÃ§en SÃ¼re</th>
            <th>Son KayÄ±t</th>
            <th>Ä°ÅŸlem</th>
          </tr>
        </thead>
        <tbody id="staleBody">
          <tr><td colspan="5" class="empty">Kontrol ediliyorâ€¦</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="dlg-foot"><button class="ghost" data-close>Kapat</button></div>
</dialog>



<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- libs -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script src="assets/qrcode.min.js"></script>

<script>
/* ==== FIREBASE ==== */
const firebaseConfig = {
  apiKey:"AIzaSyDJtcrJ6Eh4BfZnn0M-4z9QYi_2AS-ikHw",
  authDomain:"ieee-oda.firebaseapp.com",
  databaseURL:"https://ieee-oda-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"ieee-oda",
  storageBucket:"ieee-oda.firebasestorage.app",
  messagingSenderId:"788998880363",
  appId:"1:788998880363:web:5eacc71c326cffe7b3452e"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.database();


/* ==== ADMIN GATE ==== */
(async function adminGate(){
  try{
    // 1) Ä°lk auth state (user veya null)
    const user = await new Promise(resolve => {
      const off = firebase.auth().onAuthStateChanged(u => { off(); resolve(u || null); });
    });


    // 2) Login yok â†’ login.html
    if (!user) {
      location.replace('login.html?next=' + encodeURIComponent(location.href));
      return;
    }

    // 3) Admin kontrolÃ¼: claim â†’ RTDB fallback
    let isAdmin = false;
    try {
      const tok = await user.getIdTokenResult(true);
      isAdmin = !!tok?.claims?.admin;
    } catch(e) { console.warn('[gate] claim read err', e); }

    if (!isAdmin) {
      try {
        const s = await firebase.database().ref('admins/' + user.uid).get();
        isAdmin = s.exists() && (s.val() === true || s.val() === 'true' || s.val() === 1);
        console.log('[gate] rtdb admin =', isAdmin);
      } catch(e) { console.warn('[gate] rtdb read err', e); }
    }

    if (!isAdmin) {
      console.warn('[gate] not admin â†’ redirect /');
      location.replace('/');
      return;
    }
    //dÃ¼zeltme commiti

    // 4) Admin â†’ sayfayÄ± aÃ§
    window.__ADMIN__ = true;
    document.body.style.display = ''; // (body gizli deÄŸilse zaten gÃ¶rÃ¼nÃ¼r)
    console.log('[gate] OPEN');
  } catch (e) {
    console.error('[gate] fatal', e);
    // GÃ¼venli fallback: loginâ€™e dÃ¶n
    location.replace('login.html?next=' + encodeURIComponent(location.href));
  }
})();

/* ==== helpers ==== */

function dtLocalValue(d){
  const pad = n => String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}


  // --- Saatlik oda anahtarÄ± Ã¼retimi (fallback) ---
if (typeof computeHourlyKey !== 'function') {
  async function computeHourlyKey(seed, date){
    const d = new Date(date);
    const stamp = `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}T${String(d.getUTCHours()).padStart(2,'0')}`;
    const txt = `${seed}|${stamp}`;
    const enc = new TextEncoder().encode(txt);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    const hex = [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
    return hex.slice(0, 8).toUpperCase(); // 8 hane yeterli (istersen 6 da yapabilirsin)
  }
}




/* ==== 24h+ iÃ§eride kalanlar ==== */
function durFmt(ms){
  const s = Math.max(0, Math.floor(ms/1000));
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  return `${h} sa ${String(m).padStart(2,'0')} dk`;
}

async function findStaleInside(room){
  // son 7 gÃ¼n yeterli (daha eski giriÅŸler pratikte yok varsayÄ±mÄ±);
  // istersen 30 gÃ¼ne Ã§Ä±karabilirsin.
  const since = Date.now() - 7*24*3600e3;
  const snap = await db.ref('attendanceByRoom/'+room)
    .orderByChild('createdAt').startAt(since).get();

  const rows = Object.values(snap.val()||{})
    .sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));

  // her kullanÄ±cÄ± iÃ§in son stateâ€™i takip et
  const last = new Map(); // uid -> {action, ts, name}
  rows.forEach(r=>{
    if(!r.userId) return;
    last.set(r.userId, { action:r.action, ts:r.createdAt||0, name:(r.userName||r.userId) });
  });

  const now = Date.now(), out = [];
  for(const [uid, info] of last.entries()){
    if(info.action === 'enter'){
      const age = now - info.ts;
      if(age >= 24*3600e3){
        out.push({
          userId: uid,
          userName: info.name,
          enterAt: info.ts,
          ageMs: age,
          lastAction: 'enter',
          lastAt: info.ts
        });
      }
    }
  }
  // en eski baÅŸa
  out.sort((a,b)=>a.enterAt - b.enterAt);
  return out;
}

function renderStaleList(list){
  const tb = $('staleBody');
  tb.innerHTML = '';
  if(!list.length){
    tb.innerHTML = `<tr><td colspan="5" class="empty">24 saati aÅŸan aÃ§Ä±k oturum yok</td></tr>`;
    return;
  }
  tb.innerHTML = list.map(r=>`
    <tr data-uid="${r.userId}">
      <td>${esc(r.userName)}</td>
      <td>${fmt(r.enterAt)}</td>
      <td>${durFmt(r.ageMs)}</td>
      <td>${esc(r.lastAction)} @ ${fmt(r.lastAt)}</td>
      <td><button class="ghost btn-force-exit" data-uid="${r.userId}">Ã‡Ä±kÄ±ÅŸ Ver</button></td>
    </tr>
  `).join('');

  // butonlarÄ± baÄŸla
  tb.querySelectorAll('.btn-force-exit').forEach(b=>{
    b.onclick = async () => {
      const uid = b.dataset.uid, room = $('roomSelect').value;
      if(!uid || !room) return;
      if(!confirm('Bu kullanÄ±cÄ± iÃ§in â€œÃ§Ä±kÄ±ÅŸâ€ kaydÄ± oluÅŸturalÄ±m mÄ±?')) return;
      try{
        await forceExitForUser(room, uid);
        toast('Ã‡Ä±kÄ±ÅŸ verildi');
        // listeyi tazele
        const fresh = await findStaleInside(room);
        renderStaleList(fresh);
      }catch(e){
        console.error(e);
        alert('Ã‡Ä±kÄ±ÅŸ verilemedi: ' + (e.message||e));
      }
    };
  });
}



// input.value'ya yerel tarih yaz
function setDtLocal(inputId, date){
  $(inputId).value = dtLocalValue(date);
}

const $=id=>document.getElementById(id);
const fmt=ts=>new Date(ts||0).toLocaleString();
const esc=s=>String(s||'').replace(/[<>&]/g,m=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[m]));
const toast=m=>{const t=$('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600);};
const setStatus=(msg,ok=false)=>{const el=$('status'); el.className=ok?'ok':'muted'; el.textContent=msg||'';};

/* ==== auth ==== */
auth.onAuthStateChanged(async u=>{
  if(!u) return;                     // gate login'e attÄ±    
  $('mePill').textContent = u.email || u.uid;

  // normal yÃ¼klemelere devam:
  initDatePreset();
  await loadRooms();
  db.ref('fundTotals').on('value', s=>{
    const v=s.val()||{};
    const collected=+(v.collected||0), spent=+(v.spent||0);
    const cash=+(collected-spent).toFixed(2);
    $('cash').textContent=`Kasa: â‚º${cash.toFixed(2)} (Toplanan â‚º${collected.toFixed(2)} / Harcanan â‚º${spent.toFixed(2)})`;
  });
});

$('logout').onclick=()=>auth.signOut().then(()=>location.replace('login.html'));

/* ==== open/close dialogs ==== */
document.querySelectorAll('[data-open]').forEach(b=> b.addEventListener('click', ()=> $(b.dataset.open)?.showModal()));
document.querySelectorAll('dialog [data-close]').forEach(b=> b.addEventListener('click', ()=> b.closest('dialog')?.close()));
$('openQRmgr').onclick=()=> $('dlg-qr').showModal();
// dialog aÃ§Ä±ldÄ±ÄŸÄ±nda yÃ¼kle (stale list)
document.querySelector('[data-open="dlg-stale"]')?.addEventListener('click', async ()=>{
  const room = $('roomSelect').value;
  renderStaleList([]); // temizle
  const list = await findStaleInside(room);
  renderStaleList(list);
});


/* ==== rooms / filters ==== */
async function loadRooms(){
  const snap=await db.ref('roomKeys').get();
  const sel=$('roomSelect'); sel.innerHTML='';
  const rooms=Object.keys(snap.val()||{}).sort();
  rooms.forEach(r=>{const o=document.createElement('option'); o.value=r; o.textContent=r; sel.appendChild(o);});
  if(rooms.length){ sel.value=rooms[0]; await applyFilters(); }
}
$('roomSelect').onchange=()=>applyFilters();
$('refresh').onclick=()=>applyFilters();
$('live').onchange=()=>applyFilters();

function initDatePreset(){
  const preset = $('datePreset');

  const change = () => {
    const now = new Date();                 // yerel
    const end = new Date(now);              // ÅŸimdi
    const start = new Date(now);
    start.setDate(start.getDate() - 6);     // bugÃ¼n dahil son 7 gÃ¼n
    start.setHours(0,0,0,0);                // baÅŸlangÄ±cÄ± 00:00 yap

    const setCustom = (sDate, eDate) => {
      setDtLocal('startAt', sDate);
      setDtLocal('endAt',   eDate);
    };

    if (preset.value === 'today') {
      const d = new Date(); d.setHours(0,0,0,0);
      setCustom(d, now);
    } else if (preset.value === 'yesterday') {
      const d = new Date(); d.setDate(d.getDate()-1); d.setHours(0,0,0,0);
      const e = new Date(d); e.setHours(23,59,59,999);
      setCustom(d, e);
    } else if (preset.value === '7d') {
      setCustom(start, end);                // ğŸ”¹ varsayÄ±lan: son 7 gÃ¼n
    } else if (preset.value === '30d') {
      const d = new Date(now); d.setDate(d.getDate()-29); d.setHours(0,0,0,0);
      setCustom(d, end);
    }
  };

  // preset deÄŸiÅŸince uygula
  preset.onchange = () => { if (preset.value !== 'custom'){ change(); applyFilters(); } };

  // kullanÄ±cÄ± manuel deÄŸiÅŸtirirse preset'i custom yap
  $('startAt').onchange = () => { preset.value='custom'; applyFilters(); };
  $('endAt').onchange   = () => { preset.value='custom'; applyFilters(); };

  // ğŸ”¹ aÃ§Ä±lÄ±ÅŸta zorlama: her zaman 7 gÃ¼n gÃ¶ster
  preset.value = '7d';
  change();
}



async function forceExitForUser(room, userId){
  // Ã–nce son gÃ¶rÃ¼nen adÄ±nÄ± almaya Ã§alÄ±ÅŸalÄ±m (nice-to-have)
  let userName = userId;
  try{
    const s = await db.ref('users/'+userId+'/displayName').get();
    if(s.exists()) userName = s.val();
  }catch(_){}

  const pushId = db.ref().child('attendanceByRoom').push().key;
  const rec = {
    id: pushId,
    userId,
    userName,
    roomId: room,
    action: 'exit',
    createdAt: firebase.database.ServerValue.TIMESTAMP,
    method: 'admin',
    forcedBy: (auth.currentUser?.uid || 'admin')
  };

  const updates = {};
  updates[`/attendanceByUser/${userId}/${pushId}`] = rec;
  updates[`/attendanceByRoom/${room}/${pushId}`]   = rec;
  await db.ref().update(updates);
}



function getRange(){
  const now = Date.now();

  const sVal = document.getElementById('startAt')?.value || '';
  const eVal = document.getElementById('endAt')?.value || '';

  // varsayÄ±lan: son 7 gÃ¼n 00:00 â†’ ÅŸimdi
  let start = sVal ? new Date(sVal).getTime() : (()=>{ const d=new Date(now-6*86400000); d.setHours(0,0,0,0); return +d; })();
  let end   = eVal ? new Date(eVal).getTime()   : now;

  // bozuk/tarih ters ise gÃ¼venli fallback
  if (!Number.isFinite(start) || !Number.isFinite(end) || end < start){
    start = now - 6*86400000;  // 7 gÃ¼n
    end   = now;
  }
  return { start, end };
}

// BUNU ÃœSTE KOY (makeQR Ã§aÄŸrÄ±lmadan Ã¶nce)
if (typeof window.computeHourlyKey !== 'function') {
  window.computeHourlyKey = async function(seed, date){
    const d = new Date(date);
    const stamp = `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}T${String(d.getUTCHours()).padStart(2,'0')}`;
    const txt = `${seed}|${stamp}`;
    const enc = new TextEncoder().encode(txt);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    const hex = [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
    return hex.slice(0, 8).toUpperCase();
  };
}




/* ==== data ==== */
let liveOffFns=[];
async function applyFilters(){
  const room=$('roomSelect').value; if(!room) return;
  const {start,end}=getRange();
  setStatus('YÃ¼kleniyorâ€¦');
  liveOffFns.forEach(fn=>fn&&fn()); liveOffFns=[];

  const resRef=db.ref('roomReservations/'+room).orderByChild('startAt').startAt(start-30*24*3600e3).endAt(end+30*24*3600e3);
  const attRef=db.ref('attendanceByRoom/'+room).orderByChild('createdAt').startAt(start).endAt(end);
  const fbRef =db.ref('roomFeedback/'+room).orderByChild('createdAt').startAt(start).endAt(end);
  const invRef=db.ref('inventoryRequests/'+room).orderByChild('createdAt').startAt(start).endAt(end);
  const overlap=rows=>(rows||[]).filter(r=>(r.endAt||0)>=start && (r.startAt||0)<=end);

  if($('live').checked){
    const aCb=attRef.on('value',s=>renderAttendance(Object.values(s.val()||{})));
    updateStaleBadge();
    const fCb=fbRef.on('value',s=>renderFeedback(entriesWithId(s.val())));
    const iCb=invRef.on('value',s=>renderInventory(entriesWithId(s.val())));
    const rCb=resRef.on('value',s=>renderReservations(overlap(entriesWithId(s.val()))));
    liveOffFns.push(()=>attRef.off('value',aCb),()=>fbRef.off('value',fCb),()=>invRef.off('value',iCb),()=>resRef.off('value',rCb));
    setStatus('CanlÄ± dinleniyor',true);
  }else{
    const [a,f,i,r]=await Promise.all([attRef.get(),fbRef.get(),invRef.get(),resRef.get()]);
    renderAttendance(Object.values(a.val()||{}));
    renderFeedback(entriesWithId(f.val()));
    renderInventory(entriesWithId(i.val()));
    renderReservations(overlap(entriesWithId(r.val())));
    setStatus('');
  }
  calcOccupancy();
  if(!$('gateBase').value) $('gateBase').value = location.origin + '/gate.html';
  makeQR();

  await updateStaleBadge();
}
const entriesWithId=o=>Object.entries(o||{}).map(([id,v])=>({id,...v}));

async function updateStaleBadge(){
  const room=$('roomSelect').value;
  if(!room) return;
  const list = await findStaleInside(room);
  // Ä°stersen topbara bir uyarÄ± iÅŸaretleyebilirsin:
  $('mePill').textContent = list.length ? `âš ï¸ ${list.length} aÃ§Ä±k` : ($('mePill').textContent || 'â€”');
}


/* ==== renderers ==== */
function renderAttendance(rows){
  const tb=$('attBody'); tb.innerHTML=''; rows.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  if(!rows.length){ tb.innerHTML=`<tr><td colspan="5" class="empty">Veri yok</td></tr>`; return; }
  window.__attRows=rows;
  tb.innerHTML=rows.map(r=>`<tr>
    <td>${fmt(r.createdAt)}</td><td>${esc(r.userName||r.userId)}</td><td>${esc(r.action)}</td><td>${esc(r.roomId)}</td><td>${esc(r.method||'')}</td>
  </tr>`).join('');
}

function renderFeedback(rows){
  const tb=$('fbBody'); tb.innerHTML=''; rows.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  if(!rows.length){ tb.innerHTML=`<tr><td colspan="7" class="empty">Veri yok</td></tr>`; return; }
  window.__fbRows=rows;
  const q=($('fbQuery').value||'').toLowerCase();
  const state=$('fbState').value||'all';
  const filtered=rows.filter(r=>{
    const blob=[r.userName,r.comment,(r.tags||[]).join(' ')].join(' ').toLowerCase();
    const stateOk=state==='all'||(String(r.adminState||'open')===state);
    return (!q||blob.includes(q)) && stateOk;
  });
  tb.innerHTML = filtered.map(r=>`<tr>
    <td>${fmt(r.createdAt)}</td>
    <td>${esc(r.userName||r.userId)}</td>
    <td><span class="chip ${esc(r.adminState||'open')}">${esc(r.adminState||'open')}</span></td>
    <td>${'â˜…â˜…â˜…â˜…â˜…'.slice(0,r.rating||0)}${'â˜†â˜†â˜†â˜†â˜†'.slice(0,5-(r.rating||0))}</td>
    <td>
      ${esc(r.comment||'')}
      ${r.photoB64?`<div style="margin-top:6px"><button class="ghost btn-view" data-src="${r.photoB64}">FotoÄŸrafÄ± AÃ§</button></div>`:''}
    </td>
    <td>${esc((r.tags||[]).join(', '))}</td>
    <td>
      <select data-fb="${r.id}" class="fbStateSel">
        <option value="open" ${(r.adminState||'open')==='open'?'selected':''}>AÃ§Ä±k</option>
        <option value="resolved" ${(r.adminState||'open')==='resolved'?'selected':''}>Ã‡Ã¶zÃ¼ldÃ¼</option>
      </select>
    </td>
  </tr>`).join('');
  document.querySelectorAll('.fbStateSel').forEach(sel=>{
    sel.onchange=async e=>{ const id=e.target.dataset.fb, room=$('roomSelect').value; await db.ref(`roomFeedback/${room}/${id}/adminState`).set(e.target.value); setStatus('Feedback gÃ¼ncellendi',true); };
  });
  document.querySelectorAll('.btn-view').forEach(b=> b.onclick=()=>{ $('photoFull').src=b.dataset.src; $('photoDlg').showModal(); });
}
$('photoClose').onclick=()=>$('photoDlg').close();
$('fbQuery').oninput=()=>renderFeedback(window.__fbRows||[]);
$('fbState').onchange=()=>renderFeedback(window.__fbRows||[]);
$('fbClear').onclick=()=>{ $('fbQuery').value=''; $('fbState').value='all'; renderFeedback(window.__fbRows||[]); };

function renderInventory(rows){
  const tb=$('invBody'); tb.innerHTML=''; rows.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  if(!rows.length){ tb.innerHTML=`<tr><td colspan="7" class="empty">Veri yok</td></tr>`; return; }
  window.__invRows=rows;
  tb.innerHTML=rows.map(r=>`<tr>
    <td>${fmt(r.createdAt)}</td><td>${esc(r.userName||r.userId)}</td><td>${esc(r.qty)}</td>
    <td>${esc(r.name)}</td><td>${esc(r.note||'')}</td><td>${esc(r.status||'pending')}</td>
    <td>
      <div class="row" style="gap:6px">
        <select data-inv="${r.id}" class="invStatus">
          <option value="pending" ${r.status==='pending'?'selected':''}>Beklemede</option>
          <option value="ordered" ${r.status==='ordered'?'selected':''}>SipariÅŸ verildi</option>
          <option value="done" ${r.status==='done'?'selected':''}>TamamlandÄ±</option>
        </select>
        <input type="number" min="0" step="0.01" placeholder="Birim â‚º" value="${r.unitPrice||''}" style="max-width:110px" class="invPrice" data-inv="${r.id}">
        <button class="ghost invBill" data-inv="${r.id}">Fatura Kes</button>
      </div>
    </td>
  </tr>`).join('');
  document.querySelectorAll('.invStatus').forEach(sel=>{
    sel.onchange=async e=>{
      const id=e.target.dataset.inv, room=$('roomSelect').value, val=e.target.value;
      const ref=db.ref(`inventoryRequests/${room}/${id}`), s=await ref.get(); if(!s.exists()) return;
      const rec=s.val(); rec.status=val; await ref.set(rec); setStatus('Inventory gÃ¼ncellendi',true);
      if(val==='done'){
        const price=parseFloat(rec.unitPrice||'0')||0, qty=rec.qty||1;
        if(price>0){
          const total=+(price*qty).toFixed(2);
          const invRef=db.ref('invoices').push();
          const inv={id:invRef.key,userId:rec.userId,userName:rec.userName||rec.userId,roomId:room,title:`Ekipman: ${rec.name}`,lines:[{desc:rec.name,qty,unitPrice:price}],total,status:'unpaid',createdAt:Date.now(),source:'inventory',sourceId:rec.id};
          await invRef.set(inv); await db.ref(`userInvoices/${rec.userId}/${invRef.key}`).set(inv);
          setStatus('TamamlandÄ± â†’ Fatura oluÅŸturuldu',true);
        }
      }
    };
  });
  document.querySelectorAll('.invPrice').forEach(inp=>{
    inp.onchange=async e=>{ const id=e.target.dataset.inv, room=$('roomSelect').value; const v=parseFloat(e.target.value||'0')||0; await db.ref(`inventoryRequests/${room}/${id}/unitPrice`).set(v); setStatus('Birim fiyat kaydedildi',true); };
  });
  document.querySelectorAll('.invBill').forEach(btn=>{
    btn.onclick=async()=>{
      const room=$('roomSelect').value, id=btn.dataset.inv;
      const s=await db.ref(`inventoryRequests/${room}/${id}`).get(); if(!s.exists()) return alert('KayÄ±t bulunamadÄ±.');
      const rec=s.val(); const price=parseFloat(rec.unitPrice||'0')||0; if(rec.status!=='done') return alert('Ã–nce "TamamlandÄ±" yap.');
      if(price<=0) return alert('Birim fiyat girin.');
      const total=+(price*(rec.qty||1)).toFixed(2);
      const invRef=db.ref('invoices').push();
      const inv={id:invRef.key,userId:rec.userId,userName:rec.userName||rec.userId,roomId:room,title:`Ekipman: ${rec.name}`,lines:[{desc:rec.name,qty:rec.qty||1,unitPrice:price}],total,status:'paid',createdAt:Date.now(),paidAt:Date.now(),source:'inventory',sourceId:rec.id};
      await invRef.set(inv); await db.ref(`userInvoices/${rec.userId}/${invRef.key}`).set(inv);
      await addLedger('debit', total, `Ekipman alÄ±mÄ±: ${rec.name}`, {roomId:room,invId:invRef.key}); await incTotal('spent', total);
      setStatus('Fatura Ã¶dendi olarak iÅŸaretlendi. Kasa gÃ¼ncellendi.',true);
    };
  });
}


$('remAll').onclick = async () => {
  const m = ($('remMonth').value||'').trim();
  if(!m) return alert('Ay gir (YYYY-MM)');
  const snap = await db.ref('invoices').orderByChild('createdAt').limitToLast(5000).get();
  const rows = Object.values(snap.val()||{}).filter(r => r.status!=='paid' && (r.title||'').includes(m));
  for(const r of rows){ await sendReminder(r.id); }
  toast(`Toplu hatÄ±rlatma: ${rows.length} fatura`);
};



function renderReservations(rows){
  const tb=$('resBody'); tb.innerHTML=''; rows.sort((a,b)=>(a.startAt||0)-(b.startAt||0));
  if(!rows.length){ tb.innerHTML=`<tr><td colspan="7" class="empty">Veri yok</td></tr>`; return; }
  window.__resRows=rows;
  tb.innerHTML=rows.map(r=>`<tr>
    <td>${fmt(r.startAt)}</td><td>${fmt(r.endAt)}</td><td>${esc(r.userName||r.userId)}</td>
    <td>${esc(r.title||'')}</td><td>${esc(r.note||'')}</td>
    <td><span class="chip ${r.status||'pending'}">${esc(r.status||'pending')}</span></td>
    <td>
      <select data-res="${r.id}" class="resState">
        <option value="pending" ${(r.status||'pending')==='pending'?'selected':''}>Beklemede</option>
        <option value="approved" ${(r.status||'pending')==='approved'?'selected':''}>Onayla</option>
        <option value="declined" ${(r.status||'pending')==='declined'?'selected':''}>Reddet</option>
      </select>
      <button class="ghost resDel" data-res="${r.id}">Sil</button>
    </td>
  </tr>`).join('');
  document.querySelectorAll('.resState').forEach(sel=>{
    sel.onchange=async e=>{
      const id=e.target.dataset.res, room=$('roomSelect').value, val=e.target.value;
      const s=await db.ref(`roomReservations/${room}/${id}`).get(); if(!s.exists()) return;
      const rec=s.val(); rec.status=val;
      await db.ref(`roomReservations/${room}/${id}`).set(rec);
      await db.ref(`userReservations/${rec.userId}/${id}`).set(rec);
      setStatus('Rezervasyon gÃ¼ncellendi',true);
    };
  });
  document.querySelectorAll('.resDel').forEach(btn=>{
    btn.onclick=async()=>{
      if(!confirm('Bu rezervasyonu silmek istiyor musun?')) return;
      const id=btn.dataset.res, room=$('roomSelect').value;
      const s=await db.ref(`roomReservations/${room}/${id}`).get(); const rec=s.val()||{};
      await db.ref(`roomReservations/${room}/${id}`).remove();
      if(rec.userId) await db.ref(`userReservations/${rec.userId}/${id}`).remove();
      setStatus('Rezervasyon silindi',true);
    };
  });
}

/* ==== occupancy (mini bar) ==== */
async function calcOccupancy(){
  const room=$('roomSelect').value; if(!room) return;
  const since=Date.now()-24*3600*1000;
  const s=await db.ref('attendanceByRoom/'+room).orderByChild('createdAt').startAt(since).get();
  const rows=Object.values(s.val()||{}); const state=new Map();
  rows.sort((a,b)=>(a.createdAt||0)-(b.createdAt||0)).forEach(r=>{ if(r.action==='enter') state.set(r.userId,true); if(r.action==='exit') state.set(r.userId,false); });
  const inside=[...state.values()].filter(Boolean).length;
  $('occupy').textContent=`Doluluk (son 24s): ~${inside}`;
  document.querySelector('.bar > i').style.width=Math.max(6, Math.min(100, inside*12))+'%';
}

/* ==== CSV ==== */
function downloadCSV(filename, rows){
  if(!rows || !rows.length) return alert('Veri yok');
  const headers=Array.from(new Set(rows.flatMap(r=>Object.keys(r))));
  const J=v=>JSON.stringify(v===undefined?'':v);
  const lines=[headers.join(',')].concat(rows.map(r=>headers.map(h=>J(r[h])).join(',')));
  const blob=new Blob([lines.join('\n')],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
}
$('csvAttend').onclick=()=>downloadCSV('attendance.csv',window.__attRows||[]);
$('csvFeedback').onclick=()=>downloadCSV('feedback.csv',window.__fbRows||[]);
$('csvInv').onclick=()=>downloadCSV('inventory.csv',window.__invRows||[]);
$('csvRes').onclick=()=>downloadCSV('reservations.csv',window.__resRows||[]);


$('askDues').onclick = async () => {
  const m = ($('reqMonth').value||'').trim();
  const amt = parseFloat($('reqAmount').value||'0')||0;
  const emails = ($('reqEmails').value||'').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
  if(!m || amt<=0 || !emails.length) return alert('Ay, tutar, e-posta');

  const res = {ok:[], miss:[]};
  for(const mail of emails){
    const u = await findUserByEmail(mail);
    if(!u){ res.miss.push(mail); continue; }
    await db.ref(`duesRequests/${u.uid}/${m}`).set({month:m, amount:amt, createdAt:Date.now(), state:'requested'});
    res.ok.push(mail);
  }
  alert(`Ä°stendi â†’ ${res.ok.length} â€¢ BulunamadÄ± â†’ ${res.miss.length}`);
};




/* ==== QR ==== */
async function makeLink(){
  const room = $('roomSelect').value;
  if(!room) return '';

  // seed â†’ key
  const seedSnap = await db.ref('roomKeySeed/'+room).get();
  if(!seedSnap.exists()){ alert('Bu oda iÃ§in seed yok.'); return ''; }
  const seed = String(seedSnap.val());
  const nowKey = await computeHourlyKey(seed, new Date());

  const base = $('gateBase').value || (location.origin + '/gate.html');
  return `${base}?room=${encodeURIComponent(room)}&key=${encodeURIComponent(nowKey)}`;
}

async function makeQR(){
  const room = $('roomSelect').value;
  if(!room) return;

  // seed getir
  const seedSnap = await db.ref('roomKeySeed/'+room).get();
  if(!seedSnap.exists()){ alert('Bu oda iÃ§in seed yok.'); return; }
  const seed = String(seedSnap.val());

  const nowKey = await computeHourlyKey(seed, new Date());
  const link = `${$('gateBase').value || (location.origin+'/gate.html')}?room=${encodeURIComponent(room)}&key=${encodeURIComponent(nowKey)}`;





  $('qrText').textContent = link;
  await QRCode.toCanvas($('qrCanvas'), link, {width:160, margin:1});

  // Ä°stersen bitiÅŸ saatini gÃ¶ster (bir sonraki UTC saat baÅŸÄ±)
  const nextHour = new Date();
  nextHour.setUTCMinutes(0,0,0); nextHour.setUTCHours(nextHour.getUTCHours()+1);
  setStatus(`Bu QR ${nextHour.toISOString()} (UTC) saatine kadar geÃ§erli`, true);
}
$('makeQR').onclick=makeQR;
$('downloadQR').onclick=()=>{ const a=document.createElement('a'); a.href=$('qrCanvas').toDataURL('image/png'); a.download=`QR-${$('roomSelect').value}.png`; a.click(); };
$('openQR').onclick = async () => {
  const link = await makeLink();
  if(!link) return;
  $('qrLinkTxt').textContent = link;
  await QRCode.toCanvas($('qrBig'), link, {width:320, margin:1});
  $('qrDlg').showModal();
};

$('qrClose').onclick=()=>$('qrDlg').close();
$('qrDownload').onclick=()=>{ const a=document.createElement('a'); a.href=$('qrBig').toDataURL('image/png'); a.download=`QR-${$('roomSelect').value}@2x.png`; a.click(); };

/* ==== room ops ==== */
$('addRoom').onclick=async()=>{
  const r=$('newRoomId').value.trim(), k=$('newRoomKey').value.trim();
  if(!r||!k) return alert('Oda ve anahtar gerekli');
  await db.ref('roomKeys/'+r).set(k); setStatus('Oda/anahtar kaydedildi',true); await loadRooms(); $('roomSelect').value=r; await applyFilters();
};
$('rotateKey').onclick=async()=>{
  const r=$('roomSelect').value; if(!r) return;
  if(!confirm(r+' iÃ§in anahtar yenilensin mi?')) return;
  const k=Math.random().toString(36).slice(2,8).toUpperCase();
  await db.ref('roomKeys/'+r).set(k); setStatus('Anahtar yenilendi',true); await makeQR();
};
$('delRoom').onclick=async()=>{
  const r=$('roomSelect').value; if(!r) return;
  if(!confirm(`${r} odasÄ±nÄ± sil? Bu iÅŸlem geri alÄ±namaz.`)) return;
  await db.ref('roomKeys/'+r).remove(); setStatus('Oda silindi',true); await loadRooms(); await applyFilters();
};

/* ==== admin ops ==== */
async function findUserByEmail(mail){
  const q=await db.ref('users').orderByChild('email').equalTo(mail.toLowerCase()).limitToFirst(1).get();
  if(!q.exists()) return null; const [uid,rec]=Object.entries(q.val())[0]; return {uid,...rec};
}
$('findUser').onclick=async()=>{
  const mail=$('emailFind').value.trim(); if(!mail) return;
  const u=await findUserByEmail(mail);
  $('findRes').textContent = u ? `Bulundu â†’ UID: ${u.uid} â€¢ Ad: ${u.displayName||'-'}` : 'BulunamadÄ±';
  window.__foundUser=u;
};
$('makeAdmin').onclick=async()=>{ if(!window.__foundUser) return alert('Ã–nce kullanÄ±cÄ±yÄ± bul.'); await db.ref('admins/'+window.__foundUser.uid).set(true); toast('Admin verildi'); };
$('removeAdmin').onclick=async()=>{ if(!window.__foundUser) return alert('Ã–nce kullanÄ±cÄ±yÄ± bul.'); await db.ref('admins/'+window.__foundUser.uid).remove(); toast('Admin kaldÄ±rÄ±ldÄ±'); };

/* ==== finans helpers & listeler ==== */
async function addLedger(type,amount,note,meta={}){ const ref=db.ref('fundLedger').push(); await ref.set({id:ref.key,type,amount:+(amount||0),note:note||'',meta,createdAt:Date.now()}); }
async function incTotal(key,delta){ await db.ref(`fundTotals/${key}`).transaction(v=>(v||0)+(delta||0)); }

async function loadDuesPayments(){
  const snap=await db.ref('duesPaymentsIndex').orderByChild('createdAt').limitToLast(200).get();
  const rows=Object.values(snap.val()||{}).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  const tb=$('duesTable'); tb.innerHTML='';
  if(!rows.length){ tb.innerHTML=`<tr><td colspan="6" class="empty">Veri yok</td></tr>`; return; }
  tb.innerHTML=rows.map(r=>`
    <tr>
      <td>${fmt(r.createdAt)}</td>
      <td>${esc(r.userName||r.userId)}</td>
      <td>${esc(r.month||'-')}</td>
      <td>â‚º${(+r.amount||0).toFixed(2)}</td>
      <td><span class="chip ${r.status||'pending'}">${esc(r.status||'pending')}</span></td>
      <td class="row" style="gap:6px">
        ${r.status!=='approved'?`<button class="ghost" data-approve="${r.id}">Onayla</button>`:''}
        ${r.status!=='rejected'?`<button class="ghost" data-reject="${r.id}">Reddet</button>`:''}
      </td>
    </tr>`).join('');
  tb.querySelectorAll('button[data-approve]').forEach(b=> b.onclick=()=>approveDues(b.dataset.approve));
  tb.querySelectorAll('button[data-reject]').forEach(b=> b.onclick=()=>rejectDues(b.dataset.reject));
}
$('reloadDues').onclick=()=>loadDuesPayments();

async function approveDues(payId){
  const idxRef=db.ref('duesPaymentsIndex/'+payId); const s=await idxRef.get(); if(!s.exists()) return alert('KayÄ±t bulunamadÄ±.');
  const rec=s.val(); if(rec.status==='approved'){ setStatus('Zaten onaylÄ±',true); return; }
  await db.ref(`duesPayments/${rec.userId}/${payId}/status`).set('approved');
  rec.status='approved'; await idxRef.set(rec);
  const amt=+(rec.amount||0); if(amt>0){ await addLedger('credit', amt, `Aidat ${rec.month||''}`, {userId:rec.userId, payId}); await incTotal('collected', amt); }
  setStatus('Aidat onaylandÄ± ve kasa gÃ¼ncellendi',true); await loadDuesPayments();
}
async function rejectDues(payId){
  const idxRef=db.ref('duesPaymentsIndex/'+payId); const s=await idxRef.get(); if(!s.exists()) return alert('KayÄ±t bulunamadÄ±.');
  const rec=s.val(); await db.ref(`duesPayments/${rec.userId}/${payId}/status`).set('rejected'); rec.status='rejected'; await idxRef.set(rec);
  setStatus('Aidat reddedildi',true); await loadDuesPayments();
}

async function loadInvoices(){
  const snap=await db.ref('invoices').orderByChild('createdAt').limitToLast(200).get();
  const rows=Object.values(snap.val()||{}).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  const tb=$('invTable'); tb.innerHTML='';
  if(!rows.length){ tb.innerHTML=`<tr><td colspan="6" class="empty">Veri yok</td></tr>`; return; }

  tb.innerHTML=rows.map(r=>{
    const status = r.status || 'unpaid';
    const btns = status!=='paid'
      ? `<button class="ghost" data-paid="${r.id}">Ã–dendi</button>
         <button class="ghost" data-remind="${r.id}">HatÄ±rlat</button>
         <button class="ghost" data-pay="${r.id}">Ã–de</button>`
      : `<button class="ghost" data-unpaid="${r.id}">Geri Al</button>`;
    return `
      <tr>
        <td>${fmt(r.createdAt)}</td>
        <td>${esc(r.userName||r.userId)}</td>
        <td>${esc(r.title||'')}</td>
        <td>${(+r.total||0).toFixed(2)} â‚º</td>
        <td><span class="chip ${status}">${esc(status)}</span></td>
        <td class="row" style="gap:6px">
          ${btns}
          <button class="red" data-del="${r.id}">Sil</button>
        </td>
      </tr>`;
  }).join('');

  tb.querySelectorAll('button[data-paid]').forEach(b=> b.onclick=()=>markInvPaid(b.dataset.paid));
  tb.querySelectorAll('button[data-unpaid]').forEach(b=> b.onclick=()=>markInvUnpaid(b.dataset.unpaid));
  tb.querySelectorAll('button[data-del]').forEach(b=> b.onclick=()=>deleteInvoice(b.dataset.del));

  // hatÄ±rlatÄ±cÄ± + Ã¶de butonlarÄ±
  tb.querySelectorAll('button[data-remind]').forEach(b=> b.onclick=()=>sendReminder(b.dataset.remind));
  tb.querySelectorAll('button[data-pay]').forEach(b=> b.onclick=()=>openPaymentDialog(b.dataset.pay));
}




async function sendReminder(invId){
  const s=await db.ref('invoices/'+invId).get(); if(!s.exists()) return;
  const inv=s.val(); if(inv.status==='paid') return toast('Zaten Ã¶denmiÅŸ');
  const noteId = db.ref(`userNotifications/${inv.userId}`).push().key;
  const payload = {
    id: noteId, type: 'dues_reminder',
    month: (inv.title||'').replace('Aidat ','') || '',
    amount: inv.total || 0, invId, createdAt: Date.now()
  };
  await db.ref(`userNotifications/${inv.userId}/${noteId}`).set(payload);
  // sayÄ±m iÃ§in kÃ¼Ã§Ã¼k index
  await db.ref(`duesRemindersIndex/${invId}/${noteId}`).set({createdAt: payload.createdAt});
  setStatus('HatÄ±rlatma gÃ¶nderildi', true);
}



async function markInvPaid(invId){
  const s=await db.ref('invoices/'+invId).get(); if(!s.exists()) return;
  const inv=s.val(); inv.status='paid'; inv.paidAt=Date.now();
  await db.ref('invoices/'+invId).set(inv);
  await db.ref(`userInvoices/${inv.userId}/${invId}`).set(inv);
  setStatus('Fatura Ã¶dendi olarak iÅŸaretlendi',true); await loadInvoices();
}
async function markInvUnpaid(invId){
  const s=await db.ref('invoices/'+invId).get(); if(!s.exists()) return;
  const inv=s.val(); inv.status='unpaid'; delete inv.paidAt;
  await db.ref('invoices/'+invId).set(inv);
  await db.ref(`userInvoices/${inv.userId}/${invId}`).set(inv);
  setStatus('Fatura tekrar unpaid yapÄ±ldÄ±',true); await loadInvoices();
}
async function deleteInvoice(invId){
  if(!confirm('FaturayÄ± silmek istiyor musun?')) return;
  const s=await db.ref('invoices/'+invId).get(); const inv=s.val()||{};
  await db.ref('invoices/'+invId).remove();
  if(inv.userId) await db.ref(`userInvoices/${inv.userId}/${invId}`).remove();
  setStatus('Fatura silindi',true); await loadInvoices();
}

/* ==== tiles iÃ§eriÄŸi aÃ§Ä±ldÄ±ÄŸÄ±nda listeleri tazele ==== */
document.getElementById('dlg-fin')?.addEventListener('close', ()=>{});
document.querySelector('[data-open="dlg-fin"]')?.addEventListener('click', ()=>{ loadInvoices(); loadDuesPayments(); loadPaymentSettings(); });


$('fillThisMonth').onclick=()=>{
  const d=new Date(), m=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  $('finMonth').value = m; $('remMonth').value = m; $('reqMonth').value = m;
};
$('fillDefaultAmount').onclick=()=>{ $('finDueAmount').value=100; $('reqAmount').value=100; };




// ---- Aidat Kes (gÃ¼Ã§lÃ¼ sÃ¼rÃ¼m) ----
$('makeDues').onclick = async () => {
  try {
    const month = ($('finMonth').value || '').trim();         // "YYYY-MM" veya "YYYY-MM-DD"
    const amount = parseFloat($('finDueAmount').value || '0') || 0;
    const emails = ($('finEmails').value || '').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);

    if (!month || amount <= 0 || emails.length === 0) {
      alert('Ay (YYYY-MM), tutar ve en az bir e-posta girin.');
      return;
    }

    const results = {ok:[], miss:[]};

    for (const mail of emails) {
      // 1) KullanÄ±cÄ±yÄ± bul
      const u = await findUserByEmail(mail);
      if (!u) { results.miss.push({mail, reason:'users altÄ±nda yok'}); continue; }

      // 2) Fatura kaydÄ± hazÄ±rla (kurallarÄ±n istediÄŸi TÃœM alanlar)
      const invRef = db.ref('invoices').push();
      const inv = {
        id: invRef.key,
        userId: u.uid,
        userName: u.displayName || u.email || u.uid,
        roomId: $('roomSelect').value || null,
        title: `Aidat ${month}`,
        lines: [{ desc: `Aidat ${month}`, qty: 1, unitPrice: +amount }],
        total: +(+amount).toFixed(2),
        status: 'unpaid',
        createdAt: Date.now(),
        dueAt: new Date(month+'-28T23:59:59').getTime() || null,
        source: 'dues',
        sourceId: `dues-${month}`
      };

      // 3) Yaz (Ã¶nce invoices, sonra userInvoices â€” kurallarla uyumlu)
      await invRef.set(inv);
      await db.ref(`userInvoices/${u.uid}/${invRef.key}`).set(inv);

      results.ok.push({mail, uid:u.uid, invId:invRef.key});
    }

    // 4) Ã–zet
    const msg = [
      `âœ”ï¸ OluÅŸturulan: ${results.ok.length}`,
      results.ok.slice(0,5).map(r=>`- ${r.mail} â†’ ${r.invId}`).join('\n'),
      results.miss.length ? `\nâš ï¸ Atlanan: ${results.miss.length}\n` + results.miss.slice(0,5).map(r=>`- ${r.mail} (${r.reason})`).join('\n') : ''
    ].join('\n');
    console.log('Aidat Ã¶zet:', results);
    toast('Aidat oluÅŸturma tamamlandÄ±'); 
    alert(msg);

    // Listeyi gÃ¼ncelle
    await loadInvoices();

  } catch (e) {
    console.error('Aidat Kes ERR', e.code || e.name, e.message, e);
    alert('Aidat keserken hata: ' + (e.code || e.message || e));
  }
};


// Ã–deme modalÄ± iÃ§in global yardÄ±mcÄ±ler
async function getPaymentInfo(){
  // admin panelinden db'ye ekleyebilirsin: paymentInfo/default => {iban, bankName, paymentUrl}
  const snap = await db.ref('paymentInfo/default').get();
  if(!snap.exists()) return {iban:'TRXXXXXXXXXXXX...', bankName:'(HenÃ¼z ayarlanmadÄ±)', paymentUrl:''};
  return snap.val();
}

async function openPaymentDialog(invId){
  const s = await db.ref('invoices/'+invId).get(); if(!s.exists()) return alert('Fatura bulunamadÄ±');
  const inv = s.val();

  // Ã§ek default payment info
  const payInfo = await getPaymentInfo();

  // fill modal
  $('payBank').textContent = payInfo.bankName || 'â€”';
  $('payIban').textContent = payInfo.iban || 'â€”';
  $('payDesc').textContent = inv.title + (inv.lines && inv.lines.length ? ' â€” ' + (inv.lines.map(l=>l.desc).join(', ')) : '');
  $('payAmount').textContent = (+(inv.total||0)).toFixed(2) + ' â‚º';

  // payment url: Ã¶ncelik invoice.paymentUrl, sonra paymentInfo.paymentUrl
  const baseUrl = (inv.paymentUrl || payInfo.paymentUrl || '').trim();
  let finalUrl = '';
  if (baseUrl) {
    const amt = (+(inv.total||0)).toFixed(2);
    if (baseUrl.includes('{amount}')) {
      finalUrl = baseUrl.replace('{amount}', amt);
    } else if (/[?&]amount=$/i.test(baseUrl) || baseUrl.endsWith('=')) {
      finalUrl = baseUrl + amt;
    } else {
      // zaten kendi parametre formatÄ±n olabilir; dokunma
      finalUrl = baseUrl;
    }
  }

  if(finalUrl){
    $('payUrl').textContent = finalUrl;
    $('payUrl').href = finalUrl;
    $('payUrlWrap').style.display='block';
  }else{
    $('payUrl').textContent = '';
    $('payUrl').href = '';
    $('payUrlWrap').style.display='none';
  }


  // baÄŸla butonlar (her aÃ§Ä±lÄ±ÅŸta yeniden baÄŸla)
  $('copyIban').onclick = async () => {
    const text = payInfo.iban || '';
    try{
      await navigator.clipboard.writeText(text);
      toast('IBAN kopyalandÄ±');
    }catch(e){
      // fallback
      const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select();
      try{ document.execCommand('copy'); toast('IBAN kopyalandÄ±'); }catch(e2){ alert('KopyalanamadÄ± â€” lÃ¼tfen elle kopyalayÄ±n: '+text); }
      ta.remove();
    }
  };

  $('gotoBank').onclick = () => {
    if(finalUrl) { window.open(finalUrl, '_blank','noopener'); return; }
    alert('Bu fatura iÃ§in Ã¶zel bir Ã¶deme baÄŸlantÄ±sÄ± yok. LÃ¼tfen IBAN bilgisi ile internet bankacÄ±lÄ±ÄŸÄ±nÄ±zdan havale/EFT yapÄ±n.');
  };


  $('markPaidNow').onclick = async () => {
    if(!confirm('Bu faturayÄ± Ã¶denmiÅŸ olarak iÅŸaretlemek istiyor musunuz? (Bu iÅŸlem geri alÄ±nabilir)')) return;
    await markInvPaid(invId);
    $('payDlg').close();
    toast('Fatura Ã¶dendi olarak iÅŸaretlendi');
  };

  $('payDlg').showModal();
}

// (Varsa) Ã¶nceden eklediÄŸimiz getPaymentInfo() fonksiyonun varsa bunu EKLEME.
// Yoksa aÅŸaÄŸÄ±dakini ekleyebilirsin:
/*
async function getPaymentInfo(){
  const snap = await db.ref('paymentInfo/default').get();
  if(!snap.exists()) return {iban:'', bankName:'', paymentUrl:''};
  return snap.val() || {};
}
*/

function normalizeIban(raw){
  // TR xx xxxx xxxx ... â†’ boÅŸluklarÄ± toparla ve 4â€™lÃ¼ gruplara ayÄ±r
  const clean = String(raw||'').replace(/\s+/g,'').toUpperCase();
  return clean.replace(/(.{4})/g,'$1 ').trim();
}

async function loadPaymentSettings(){
  try{
    const v = await getPaymentInfo();
    $('payBankName').value = v.bankName || '';
    $('payIbanInp').value  = v.iban || '';
    $('payUrlInp').value   = v.paymentUrl || '';
  }catch(e){
    console.error('loadPaymentSettings ERR', e);
  }
}

$('payIbanInp')?.addEventListener('blur', ()=>{
  $('payIbanInp').value = normalizeIban($('payIbanInp').value);
});

$('savePayInfo')?.addEventListener('click', async ()=>{
  try{
    const payload = {
      bankName: ($('payBankName').value||'').trim(),
      iban: normalizeIban($('payIbanInp').value||''),
      paymentUrl: ($('payUrlInp').value||'').trim()
    };

    // minicik doÄŸrulama
    const ibanCompact = payload.iban.replace(/\s/g,'');
    if(!(ibanCompact.startsWith('TR') && ibanCompact.length>=12)){
      alert('IBAN doÄŸru gÃ¶rÃ¼nmÃ¼yor. LÃ¼tfen kontrol edin.');
      return;
    }

    await db.ref('paymentInfo/default').set(payload);
    $('payInfoMsg').textContent = 'Kaydedildi';
    setStatus('Ã–deme ayarlarÄ± kaydedildi', true);
    setTimeout(()=>{$('payInfoMsg').textContent='';}, 1500);
  }catch(e){
    console.error('savePayInfo ERR', e);
    alert('Kaydederken hata: ' + (e.message||e));
  }
});


/* ==== done ==== */
</script>
</body>
</html>

